<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://aadegtytarev.github.io/mkdocs-test/soft/wb-mqtt-serial/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>wb-mqtt-serial - Wiren Board Docs</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "wb-mqtt-serial";
        var mkdocs_page_input_path = "soft/wb-mqtt-serial/index.md";
        var mkdocs_page_url = "/mkdocs-test/soft/wb-mqtt-serial/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Wiren Board Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Софт</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">ПО Wiren Board</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wb-mqtt-homeui/">wb-mqtt-homeui</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">wb-mqtt-serial</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_1">Описание</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_2">Поддерживаемые протоколы</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_3">Управление драйвером</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_4">Файл конфигурации и шаблоны</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_5">Общая информация</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_6">Шаблоны конфигурации</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_7">Перевод названий параметров устройств</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_8">Особенности работы драйвера</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_9">Таймауты и количество неудачных циклов</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_11">Диаграмма таймаутов цикла опроса</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#-">Объединенное чтение регистров и его авто-отключение</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_12">Список сконфигурированных портов</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_13">Прямое чтение и запись в порт</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_16">Прямая установка параметров связи устройства</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_17">Протоколы</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_18">Поддержка различных протоколов на одной шине</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#modbus">Modbus</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_19">Широковещательные сообщения</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#61107">Энергомера ГОСТ МЭК 61107</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#32-61107">НЕВА МТ 32х ГОСТ МЭК 61107</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dlmscosem">DLMS/COSEM и СПОДЭС</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#somfy-sdn">Somfy SDN</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#windeco">WinDeco</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dooya">Dooya</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dauerhaft">Dauerhaft</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#200">Меркурий 200</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#230">Меркурий 230</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#device_type">Таблица шаблонов device_type</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../wb-rules/">wb-rules</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Wiren Board Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Софт</li>
      <li class="breadcrumb-item active">wb-mqtt-serial</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/aadegtyarev/mkdocs-test/edit/master/docs/soft/wb-mqtt-serial/index.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="wb-mqtt-serial">wb-mqtt-serial<a class="headerlink" href="#wb-mqtt-serial" title="Permanent link">&para;</a></h1>
<p>Драйвер master-slave протоколов для устройств, работающих через
последовательный порт. Драйвер предназначен для устройств <a href="https://wirenboard.com/ru">Wiren Board</a>.</p>
<p><strong>Содержание</strong></p>
<ul>
<li><a href="#описание">Описание</a></li>
<li><a href="#поддерживаемые-протоколы">Поддерживаемые протоколы</a></li>
<li><a href="#управление-драйвером">Управление драйвером</a></li>
<li><a href="#файл-конфигурации-и-шаблоны">Файл конфигурации и шаблоны</a></li>
<li><a href="#общая-информация">Общая информация</a></li>
<li><a href="#шаблоны-конфигурации">Шаблоны конфигурации</a></li>
<li><a href="#перевод-названий-параметров-устройств">Перевод названий параметров устройств</a></li>
<li><a href="#особенности-работы-драйвера">Особенности работы драйвера</a></li>
<li><a href="#таймауты-и-количество-неудачных-циклов">Таймауты и количество неудачных циклов</a></li>
<li><a href="#замечания-для-tcp-или-modbus-tcp-порта">Замечания для TCP или MODBUS TCP порта</a></li>
<li><a href="#диаграмма-таймаутов-цикла-опроса">Диаграмма таймаутов цикла опроса</a></li>
<li><a href="#объединенное-чтение-регистров-и-его-авто-отключение">Объединенное чтение регистров и его авто-отключение</a></li>
<li><a href="#прямое-чтение-и-запись-в-порт">Прямое чтение и запись в порт</a></li>
<li><a href="#протоколы">Протоколы</a></li>
<li><a href="#поддержка-различных-протоколов-на-одной-шине">Поддержка различных протоколов на одной шине</a></li>
<li><a href="#широковещательные-сообщения">Широковещательные сообщения</a></li>
<li><a href="#энергомера-гост-мэк-61107">Энергомера ГОСТ МЭК 61107</a></li>
<li><a href="#нева-мт-32х-гост-мэк-61107">НЕВА МТ 32х ГОСТ МЭК 61107</a></li>
<li><a href="#dlmscosem-и-сподэс">DLMS/COSEM и СПОДЭС</a></li>
<li><a href="#somfy-sdn">Somfy SDN</a></li>
<li><a href="#windeco">WinDeco</a></li>
<li><a href="#dooya">Dooya</a></li>
<li><a href="#dauerhaft">Dauerhaft</a></li>
<li><a href="#меркурий-200">Меркурий 200</a></li>
<li><a href="#меркурий-230">Меркурий 230</a></li>
<li><a href="#таблица-шаблонов-device_type">Таблица шаблонов device_type</a></li>
</ul>
<h2 id="_1">Описание<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">Поддерживаемые протоколы<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>Драйвер wb-mqtt-serial поддерживает устройства, работающие по протоколам:</p>
<ul>
<li><a href="https://modbus.org">Modbus</a>,</li>
<li><a href="http://smart.uniel.ru">Uniel</a>,</li>
<li><a href="http://www.eksis.ru/catalog/measures-of-relative-humidity-and-temperature/">ИВТМ</a>,</li>
<li><a href="http://www.incotexcom.ru/m230art.htm">Меркурий 230</a>,</li>
<li><a href="http://www.incotexcom.ru/m200.htm">Меркурий 200</a>,</li>
<li><a href="http://www.milur.ru">Милур</a>,</li>
<li><a href="http://www.energomera.ru">Энергомера ГОСТ МЭК 61107</a>,</li>
<li><a href="https://www.meters.taipit.ru">НЕВА МТ 32х ГОСТ МЭК 61107</a>,</li>
<li><a href="https://www.dlms.com">DLMS/COSEM</a>, СПОДЭС (ГОСТ Р 58940-2020),</li>
<li><a href="https://www.somfy.com">Somfy SDN</a>,</li>
<li>WinDeco,</li>
<li>Dooya,</li>
<li>Dauerhaft/<a href="https://a-okmotors.com">A-OK</a>.</li>
</ul>
<h3 id="_3">Управление драйвером<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>По умолчанию драйвер установлен на всех контроллерах Wiren Board и запускается автоматически при наличии непустого конфигурационного файла <code>/etc/wb-mqtt-serial.conf</code>. При первоначальной установке пакета создаётся конфигурационный файл, в котором не описано ни одного подключенного устройства. Добавьте устройства в <code>/etc/wb-mqtt-serial.conf</code>, либо воспользуйтесь онлайн-редактором настроек для начала работы.</p>
<p>Настройка пользователем производится через веб-интерфейс контроллера, но вы можете управлять им вручную:</p>
<ul>
<li><code>systemctl start wb-mqtt-serial</code> — запустить</li>
<li><code>systemctl stop wb-mqtt-serial</code> — остановить</li>
<li><code>systemctl status wb-mqtt-serial</code> — узнать состояние</li>
</ul>
<p>Возможен запуск демона вручную, что может быть полезно
для работы в отладочном режиме:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code># service wb-mqtt-serial stop
# wb-mqtt-serial -c /etc/wb-mqtt-serial.conf -d
</code></pre></div></td></tr></table></div>
<h2 id="_4">Файл конфигурации и шаблоны<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">Общая информация<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>Конфигурационный файл построен по трёхуровневой схеме:
порты (ports) -&gt; устройства (devices) -&gt; каналы (channels).</p>
<p>Конфигурация устройства device может быть задана двумя способами: вручную прописать все параметры или задать только несколько параметров.</p>
<p>Пример файла конфигурации с описанием параметров:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code>{
    // По DeviceType драйвер будет искать в папках с шаблонами описаний устройств
    &quot;device_type&quot; : &quot;DeviceType&quot;,

    // отображаемое имя устройства. Публикуется как
    // .../meta/name в MQTT
    // По умолчанию name берется из шаблона и добавляется slave_id, т.е.
    // &quot;name&quot; + &quot; &quot; + &quot;slave_id&quot;
    &quot;name&quot; : &quot;somename&quot;,

    // уникальный идентификатор устройства в MQTT.
    // каждый элемент в devices должен иметь уникальный id
    // topic&#39;и, относящиеся в MQTT к данному устройству,
    // имеют общий префикс /devices/&lt;идентификатор топика&gt;/...
    // также по умолчанию берется из шаблона с добавлением slave_id:
    // &quot;deviceID&quot; + &quot;_&quot; + slave_id
    &quot;id&quot; : &quot;deviceID&quot;,

    // идентификатор slave
    &quot;slave_id&quot; : slaveID,

    // включить/выключить устройство. В случае задания
    // &quot;enabled&quot;: false опрос устройства и запись значений
    // его каналов не происходит. По умолчанию - true.
    &quot;enabled&quot; : true,

    // если используется шаблон устройства, определения
    // каналов совмещаются. Если имя (name) в определении
    // канала устройства совпадает с именем канала в шаблоне,
    // свойства каналов из шаблона и определения устройства
    // совмещаются, при этом значения свойств из определения
    // устройства (в файле конфигурации) имеют преимущество.
    // Это можно использовать, например, для задания индивидуальных
    // интервалов опроса каналов. Если канал с таким же
    // именем, как канал в определении устройства, отсутствует
    // в шаблоне, создаётся новый канал.
    &quot;channels&quot;: [
        {
            // имя канала. topic&#39;и, соответствующие каналу,
            &quot;name&quot; : &quot;Temp 1&quot;,
            &quot;read_period_ms&quot;: 10000
        }
    ]
}
</code></pre></div></td></tr></table></div>
<p>Ниже приведён пример конфигурационного файла <code>/etc/wb-mqtt-serial.conf</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span></pre></div></td><td class="code"><div><pre><span></span><code>{
    // опция debug включает или выключает отладочную печать.
    // Опция -d командной строки wb-mqtt-serial также
    // включает отладочную печать и имеет приоритет над
    // данной опцией.
    &quot;debug&quot;: false,

    // Задаёт интервал в секундах, в течение которого неизменяющиеся значения не будут публиковаться в MQTT.
    // По истечении интервала (но не чаще периода чтения канала) полученное значение будет опубликовано, даже если оно не изменилось.
    // Минимальный интервал - 5 секунд.
    // Если установлено отрицательное значение, то значения будут публиковаться только при изменении. Это поведение по умолчанию.
    &quot;max_unchanged_interval&quot;: -1,

    // Задаёт максимальное число чтений регистров в секунду.
    // Не влияет на чтение регистров с заданным интервалом опроса.
    // Для снижения нагрузки на процессор рекомендуется задавать значение не более 100 для WB6 и не более 800 для WB7
    &quot;rate_limit&quot;: 100,

    // список портов
    &quot;ports&quot;: [
        {
            // тип порта:
            // - &quot;serial&quot;: последовательные порты RS-485 или RS-232. Это значение выбирается по умолчанию.
            // - &quot;tcp&quot;: serial over TCP/IP. Пакеты, формируемые для работы с последовательными портами, передаются без изменений через TCP/IP.
            // - &quot;modbus tcp&quot;: передача по MODBUS TCP. В секции устройств с таким типом порта могут использоваться только те, что поддерживают MODBUS.
            &quot;port_type&quot;: &quot;serial&quot;,

            // устройство, соответствующее порту RS-485 (если выбран тип порта serial)
            &quot;path&quot;: &quot;/dev/ttyRS485-1&quot;,

            // IP адрес или имя хоста (если выбран тип порта TCP или MODBUS TCP)
            &quot;address&quot;: &quot;127.0.0.1&quot;,

            // TCP порт (если выбран тип порта TCP или MODBUS TCP)
            &quot;port&quot;: 3000,

            // скорость порта
            &quot;baud_rate&quot;: 9600,

            // чётность - N, O или E (по умолчанию - N)
            &quot;parity&quot;: &quot;N&quot;,

            // количество бит данных (по умолчанию - 8)
            &quot;data_bits&quot;: 8,

            // количество стоп-бит
            &quot;stop_bits&quot;: 2,

            // Максимальное время ответа устройств, подключенных к этому порту, в миллисекундах
            // Если не установлено, то принимается равным 500 мс
            // Этот параметр задан в шаблонах описания устройств, переопределять его можно только в случае некорректной работы с устройствами
            &quot;response_timeout_ms&quot;: 100,

            // Дополнительная задержка перед каждой отправкой данных в порт в микросекундах
            // Если при работе с устройством теряются пакеты — попробуйте увеличить значение этого параметра.
            // Для соответствия протоколу Modbus RTU, установите этот параметр в значение не менее 3.5 символа при выбранной скорости — это не нужно для устройств Wiren Board, но может потребоваться для устройств сторонних производителей. Нужное значение рассчитывается по формуле: guard_interval_us = (3.5*11*10^6)/(скорость в бит/с). Например, для скорости 9600 бит/с guard_interval_us = (3.5*11*10^6)/9600 ≈ 4000 мкс.
            &quot;guard_interval_us&quot;: 1000,

            // Таймаут соединения (только для TCP или MODBUS TCP порта).
            // Если в течение указанного времени ни по одному устройству на порту не поступило данных (а также истек &quot;connection_max_fail_cycles&quot;),
            // TCP соединение будет разорвано и произойдет попытка переподключения
            &quot;connection_timeout_ms&quot;: 5000,

            // Количество неудачных циклов опроса (только для TCP или MODBUS TCP порта)
            // Если в течение указанного количества циклов опроса ни по одному устройству на порту не поступило данных (а также истек &quot;connection_timeout_ms&quot;),
            // TCP соединение будет разорвано и произойдет попытка переподключения
            &quot;connection_max_fail_cycles&quot;: 2,

            // включить/выключить порт. В случае задания
            // &quot;enabled&quot;: false опрос порта и запись значений
            // каналов в устройства на данном порту не происходит.
            // По умолчанию - true.
            &quot;enabled&quot;: true,

            // список устройств на данном порту
            &quot;devices&quot;: [
                {
                    // тип устройства, в системе должен быть корректный шаблон для этого типа
                    &quot;device_type&quot;: &quot;MSU34+TLP&quot;,

                    // отображаемое имя устройства. Публикуется как
                    // .../meta/name в MQTT
                    &quot;name&quot;: &quot;MSU34+TLP&quot;,

                    // уникальный идентификатор устройства в MQTT.
                    // каждое элемент в devices должен иметь уникальный id
                    // topic&#39;и, относящиеся в MQTT к данному устройству,
                    // имеют общий префикс /devices/&lt;идентификатор топика&gt;/...
                    &quot;id&quot;: &quot;msu34tlp&quot;,

                    // идентификатор устройства.
                    // Если не указан, то используются широковещательные запросы
                    &quot;slave_id&quot;: 2,

                    // включить/выключить устройство. В случае задания
                    // &quot;enabled&quot;: false опрос устройства и запись значений
                    // его каналов не происходит. По умолчанию - true.
                    &quot;enabled&quot;: true,

                    // протокол передачи устройства, если не задан, то используется &quot;modbus&quot;
                    &quot;protocol&quot;: &quot;modbus&quot;,

                    // максимальное количество считываемых &quot;пустых&quot; регистров.
                    // Драйвер в целях оптимизации может считывать регистры
                    // &quot;пачкой&quot;. При этом, если какие-либо регистры не
                    // были включены в конфигурацию, но в целях ускорения
                    // опроса (чтобы не разрывать &quot;пачку&quot;) их всё-таки
                    // можно считывать, можно указать значение max_reg_hole
                    // больше 0. В данный момент поддерживается только
                    // устройствами Modbus.
                    &quot;max_reg_hole&quot;: 10,

                    // то же самое, что max_reg_hole, но для однобитовых
                    // регистров (coils и discrete inputs в Modbus). В данный
                    // момент поддерживается только устройствами Modbus.
                    &quot;max_bit_hole&quot;: 80,

                    // Включить режим непрерывного чтения регистров.
                    // Поддерживается только в устройствах Wiren Board
                    &quot;enable_wb_continuous_read&quot;: true,

                    // максимальное количество регистров в одной пакетной операции
                    // чтения. В данный момент поддерживается только устройствами
                    // Modbus.
                    &quot;max_read_registers&quot;: 10,

                    // минимальное количество регистров в одной пакетной операции
                    // чтения. В данный момент поддерживается только устройствами
                    // Modbus.
                    &quot;min_read_registers&quot;: 1,

                    // Максимальное время ответа устройства в миллисекундах.
                    // Если не установлено, то принимается равным 500 мс.
                    // Если значение этого параметра, установленное для порта, больше указанного здесь, используется значение порта.
                    // Этот параметр задан в шаблонах описания устройств, переопределять его можно только в случае некорректной работы с устройством.
                    &quot;response_timeout_ms&quot;: 100,

                    // Минимально необходимая задержка между посылками в миллисекундах.
                    // Используется в некоторых протоколах для определения границ посылок.
                    // Этот параметр задан в шаблонах описания устройств, переопределять его можно только в случае некорректной работы с устройством.
                    // По умолчанию 20 мс
                    &quot;frame_timeout_ms&quot;: 100,

                    // Принудительно использовать определения границ пакета по времени между передачей байт.
                    // В протоколе MODBUS для ускорения опроса после получения нужного числа байт в ответе, сразу шлётся следующий запрос.
                    // Включение этого параметра приведёт к тому, что сервис будет ожидать время,
                    // равное frame_timeout_ms, даже после получения полного ответа.
                    // Данные, полученные сверх ожидаемой длины ответа, будут отброшены, а частота опроса может уменьшиться.
                    // По умолчанию false
                    &quot;force_frame_timeout&quot;: true,

                    // Дополнительная задержка перед каждой отправкой данных в порт в микросекундах.
                    // Если не установлено, то используется значение, заданное в соответствующем параметре порта.
                    &quot;guard_interval_us&quot;: 0,

                    // (При возникновении ошибки) Интервал после последнего успешного обмена данными с устройством,
                    // по истечении которого (а также &quot;device_max_fail_cycles&quot;) устройство будет помечено отключенным и будет опрашиваться в ограниченном режиме
                    &quot;device_timeout_ms&quot;: 3000,

                    // Количество неудачных циклов опроса устройства
                    // Если в течение указанного количества полных циклов опроса ни по одному регистру устройства не поступило данных (а также истек &quot;device_timeout_ms&quot;),
                    // устройство будет помечено отключенным и будет опрашиваться в ограниченном режиме
                    &quot;device_max_fail_cycles&quot;: 2,

                    // Время в секундах, в течение которого будут продолжаться попытки записи регистра
                    // При нуле, будет произведена только одна попытка записи регистра
                    &quot;max_write_fail_time_s&quot;: 600,

                    // Минимальное время в миллисекундах между получением ответа от устройства и следующим запросом к нему
                    &quot;min_request_interval&quot;: 10,

                    // пароль для доступа к устройству, массив байт
                    &quot;password&quot;: [1, 2, 3],

                    // уровень доступа при опросе устройства,
                    // используется для обмена с счётчиками электроэнергии
                    &quot;access_level&quot;: 1,

                    // Параметр, заданный в шаблоне устройства
                    &quot;param1&quot;: 10,

                    // список каналов устройства
                    &quot;channels&quot;: [
                        {
                            // имя канала, используется в диагностических сообщениях и,
                            // если не задан параметр id, для формирования названия MQTT topic&#39;ов канала
                            &quot;name&quot;: &quot;Temp 1&quot;,

                            // имя MQTT контрола канала. topic&#39;и, соответствующие каналу,
                            // публикуются как /devices/&lt;идентификатор устройства&gt;/controls/&lt;ID канала&gt;
                            // если не задан, то используется значение параметра name
                            &quot;id&quot;: &quot;Temp&quot;,

                            // Включает канал в цикл опроса. По умолчанию, равен true.
                            &quot;enabled&quot;: true,

                            // тип регистра
                            // возможные значения для Modbus:
                            // &quot;coil&quot; - 1 бит, чтение/запись
                            // &quot;discrete&quot; - 1 бит, только чтение
                            // &quot;holding&quot; - 16 бит, чтение/запись, код функции на запись выбирается автоматически, в зависимости от размера
                            // &quot;input&quot; - 16 бит, только чтение
                            // &quot;holding_single&quot; - то же что и holding однако регистры записываются всегда по одному, кодом 06
                            // &quot;holding_multi&quot; - то же что и holding однако регистры записываются всегда кодом 16
                            &quot;reg_type&quot;: &quot;input&quot;,

                            // адрес первого регистра канала
                            // Можно читать отдельные биты полученных регистров, для этого запишите адрес в формате:
                            //   &quot;address&quot;:&quot;reg:shift:width&quot;, где
                            //    reg — адрес первого регистра,
                            //    shift — смещение от младшего бита первого регистра,
                            //    width — количество считываемых битов.
                            // Например, &quot;address&quot;:&quot;109:1:2&quot; — прочитать второй и третий биты регистра, расположенного по адресу 109.
                            &quot;address&quot;: 0,

                            // тип элемента управления, например,
                            // &quot;temperature&quot;, &quot;text&quot;, &quot;switch&quot;

                            &quot;type&quot;: &quot;temperature&quot;,

                            // формат канала. Задаётся для регистров типа
                            // &quot;holding&quot; и &quot;input&quot;. Возможные значения:
                            // &quot;u16&quot; - беззнаковое 16-битное целое
                            //         (используется по умолчанию)
                            // &quot;s16&quot; - знаковое 16-битное целое
                            // &quot;u8&quot; - беззнаковое 8-битное целое
                            // &quot;s8&quot; - знаковое 8-битное целое
                            // &quot;u32&quot; - беззнаковое 32-битное целое (big-endian).
                            //     (занимает 2 регистра, начиная с указанного)
                            // &quot;s32&quot; - знаковое 32-битное целое (big-endian).
                            //     (занимает 2 регистра, начиная с указанного)
                            // &quot;s64&quot; - знаковое 64-битное целое (big-endian).
                            //     (занимает 4 регистра, начиная с указанного)
                            // &quot;u64&quot; - беззнаковое 64-битное целое (big-endian).
                            //     (занимает 4 регистра, начиная с указанного)
                            //
                            // &quot;float&quot; - число с плавающей точкой IEEE 754. 32 bit. (big-endian).
                            //     (занимает 2 регистра, начиная с указанного)
                            // &quot;double&quot; - число с плавающей точкой двойной точности IEEE 754. 64 bit. (big-endian).
                            //     (занимает 4 регистра, начиная с указанного)
                            // &quot;char8&quot; - однобайтовый символ в кодировке ASCII
                            // &quot;string&quot; - строка с настраиваемым количеством символов.
                            //            Для протокола modbus строки считываются по одному символу на регистр из младшего байта.
                            //            При использовании формата string обязательно указывать параметр &quot;string_data_size&quot;.
                            //
                            // &quot;bcd8&quot; -  8-битный BCD (двоично-десятичный код)
                            // &quot;bcd16&quot; - 16-битный BCD (двоично-десятичный код)
                            // &quot;bcd24&quot; - 24-битный BCD (двоично-десятичный код)
                            // &quot;bcd32&quot; - 32-битный BCD (двоично-десятичный код)

                            &quot;format&quot;: &quot;s8&quot;,

                            // Порядок 16-битных слов для каналов, имеющих размер больше 16 бит.
                            // Возможные значения:
                            //  &quot;big_endian&quot; (по-умолчанию): [0xAA 0xBB] [0xCC 0xDD] =&gt; 0xAABBCCDD
                            //  &quot;little_endian&quot;:  [0xAA 0xBB] [0xCC 0xDD] =&gt; 0xCCDDAABB
                            &quot;word_order&quot; : &quot;big_endian&quot;,

                            // Период чтения данного канала в миллисекундах
                            // Рекомендуется использовать для каналов, данные от которых надо получать с минимальными задержками
                            // Чтение каналов с заданным периодом имеет больший приоритет, чем чтение других каналов
                            // Если не указан, чтение будет производиться в свободное от опроса других каналов время
                            &quot;read_period_ms&quot;: 10,

                            // Интервал в миллисекундах, который должен пройти между двумя последовательными чтениями канала.
                            // Учитывается, если не задан параметр &quot;read_period_ms&quot;.
                            // Не рекомендуется к использованию, поддерживается для обратной совместимости с ранее созданными конфигурационными файлами.
                            // Вместо него рекомендуется использовать read_period_ms.
                            &quot;read_rate_limit_ms&quot;: 10000,

                            // значение, получаемое при последовательном чтении диапазона регистров, если устройство не поддерживает запрашиваемый регистр.
                            // Этот параметр используется некоторыми протоколами, чтобы определить доступность регистров устройства.
                            &quot;unsupported_value&quot;: &quot;0xFFFE&quot;,

                            // максимальное значение регистра, используется для построения интерфейса веб-конфигуратора
                            &quot;max&quot;: 100,

                            // коэффициент, на который умножается значение регистра перед публикацией в MQTT
                            &quot;scale&quot;: 0.5,

                            // значение, которое прибавляется к значению регистра перед публикацией в MQTT
                            &quot;offset&quot;: -12.5,

                            // порядок, до которого будет округляться значение после всех преобразований
                            &quot;round_to&quot;: 0.1,

                            // использовать события быстрого Modbus, если поддерживается прошивкой устройства.
                            // используйте &quot;sporadic&quot; для дискретных каналов — будут использоваться события вместо опроса
                            // и &quot;semi-sporadic&quot; для аналоговых — будут использоваться события совместно с опросом,
                            // это позволит избежать «застывания» значений аналогового канала.
                            &quot;sporadic&quot;: true,

                            // Список возможных значений
                            &quot;enum&quot;: [1, 2, 3],

                            // Надписи значений
                            &quot;enum_titles&quot;: [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;],

                            // доступен ли канал для записи через MQTT
                            &quot;readonly&quot;: true,

                            // значение, которое будет записано в регистр, при записи единицы в on-топик в MQTT
                            &quot;on_value&quot;: &quot;0xFF&quot;,

                            // значение, которое будет записано в регистр, при записи нуля в on-топик в MQTT
                            &quot;off_value&quot;: &quot;0xAA&quot;,

                            // значение регистра, полученное от устройства, которое обозначает ошибку
                            &quot;error_value&quot;: &quot;0xAA&quot;,

                            // Длина строки в символах. Необходимая опция, если выбран формат &quot;string&quot;
                            &quot;string_data_size&quot;: 5
                        },
                        {
                            // Ещё один канал
                            &quot;name&quot;: &quot;Illuminance&quot;,
                            &quot;reg_type&quot;: &quot;input&quot;,
                            &quot;address&quot;: 1,
                            &quot;type&quot;: &quot;text&quot;
                        },
                        {
                            &quot;name&quot;: &quot;Pressure&quot;,
                            &quot;reg_type&quot;: &quot;input&quot;,
                            &quot;address&quot;: 2,
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;scale&quot;: 0.075
                        },
                        {
                            &quot;name&quot;: &quot;Temp 2&quot;,
                            &quot;reg_type&quot;: &quot;input&quot;,
                            &quot;address&quot;: 3,
                            &quot;type&quot;: &quot;temperature&quot;,
                            &quot;format&quot;: &quot;s8&quot;
                        }
                    ]
                },
                {
                    // ещё одно устройство на канале
                    &quot;name&quot;: &quot;DRB88&quot;,
                    &quot;id&quot;: &quot;drb88&quot;,
                    &quot;enabled&quot;: true,
                    &quot;slave_id&quot;: 22,

                    // секция инициализации
                    &quot;setup&quot;: [
                        {
                            // название регистра
                            // Выводится в случае включённой отладочной печати.
                            &quot;title&quot;: &quot;Input 0 type&quot;,

                            // адрес регистра
                            &quot;address&quot;: 1,

                            // значение для записи
                            &quot;value&quot;: 1,

                            // тип регистра, если не указан, то для Modbus используется &quot;holding&quot;
                            &quot;reg_type&quot;: &quot;input&quot;,

                            // формат регистра, для Modbus по умолчанию u16
                            &quot;format&quot;: &quot;s8&quot;
                        },
                        {
                            &quot;title&quot;: &quot;Input 0 module&quot;,
                            &quot;address&quot;: 3,
                            &quot;value&quot;: 3
                        }
                    ],
                    &quot;channels&quot;: [
                        {
                            &quot;name&quot;: &quot;Relay 1&quot;,
                            &quot;reg_type&quot;: &quot;coil&quot;,
                            &quot;address&quot;: 0,
                            &quot;type&quot;: &quot;switch&quot;
                        },
                        {
                            &quot;name&quot;: &quot;Relay 2&quot;,
                            &quot;reg_type&quot;: &quot;coil&quot;,
                            &quot;address&quot;: 1,
                            &quot;type&quot;: &quot;switch&quot;
                        },
                        // ...
                        {
                            &quot;name&quot;: &quot;Input 2&quot;,
                            &quot;reg_type&quot;: &quot;input&quot;,
                            &quot;address&quot;: 1,
                            &quot;type&quot;: &quot;switch&quot;,
                            &quot;on_value&quot;: 101
                        },
                        {
                            &quot;name&quot;: &quot;Input 3&quot;,
                            &quot;reg_type&quot;: &quot;input&quot;,
                            &quot;address&quot;: 2,
                            &quot;type&quot;: &quot;switch&quot;,
                            &quot;on_value&quot;: 101
                        },
                        // ...
                    ]
                }
            ]
        },
        {
            // ещё один порт со своим набором устройств
            &quot;path&quot;: &quot;/dev/ttyNSC1&quot;,
            &quot;baud_rate&quot;: 9600,
            &quot;parity&quot;: &quot;N&quot;,
            &quot;data_bits&quot;: 8,
            &quot;stop_bits&quot;: 1,
            &quot;enabled&quot;: true,
            &quot;devices&quot;: [
                {
                    &quot;name&quot;: &quot;tM-P3R3&quot;,
                    &quot;id&quot;: &quot;tmp3r3&quot;,
                    &quot;enabled&quot;: true,
                    &quot;slave_id&quot;: 1,
                    &quot;channels&quot;: [
                        {
                            &quot;name&quot;: &quot;Relay 0&quot;,
                            &quot;reg_type&quot;: &quot;coil&quot;,
                            &quot;address&quot;: 0,
                            &quot;type&quot;: &quot;switch&quot;
                        },
                        // ...
                    ]
                },
                // ...
            ]
        }
    ]
}
</code></pre></div></td></tr></table></div>
<h3 id="_6">Шаблоны конфигурации<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>Шаблоны создаются для удобства конфигурации Modbus-устройств.</p>
<p>Шаблон конфигурации представляет собой .json файл, который содержит информацию о регистрах и параметрах устройства.</p>
<p>Для примера в <a href="config.sample.json">файле</a> приведены разные варианты записи параметров:</p>
<ul>
<li>первое устройство задано через шаблон;</li>
<li>второе устройство тоже через шаблон, но параметры "name" и "id" заданы, и можно добавить конфигурацию для канала, который добавится к тем, что есть в шаблоне;</li>
<li>параметры третьего устройства записаны явно;</li>
<li>для четвёртого задано значение одного из параметров. Параметр описан в шаблоне.</li>
</ul>
<p>В состав пакета изначально входят шаблоны конфигурации некоторых поддерживаемых устройств. Они хранятся на контроллере в папке <code>/usr/share/wb-mqtt-serial/templates</code>. Для хранения пользовательских шаблонов используется папка <code>/etc/wb-mqtt-serial.conf.d/templates</code>.</p>
<p>Для создания собственного шаблона можно скопировать существующий из папки <code>/usr/share/wb-mqtt-serial/templates</code>, изменить в нем нужные параметры, добавить необходимые регистры устройства и сохранить его в папку <code>/etc/wb-mqtt-serial.conf.d/templates</code> с новым именем.</p>
<p>При необходимости внести обратно несовместимые изменения в шаблон, его необходимо отметить устаревшим (добавить <code>"deprecated": true</code>) и создать его копию (при этом в <code>device_type</code> нового шаблона добавить префикс с версией <code>tpl1_</code>, <code>tpl2_</code> и т.д.).</p>
<p>После добавления шаблона конфигурации вы можете выбрать новое устройство из выпадающего списка в настройках serial устройств в веб-интерфейсе контроллера Wiren Board.</p>
<p>Пример шаблона:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code>{
    // Название типа устройства, оно указывается в поле device_type в файле настроек
    &quot;device_type&quot;: &quot;Device type name&quot;,

    // Группа устройств в выпадающем списке в настройках последовательного порта в веб-интерфейсе контроллера
    // Если не задано устройство будет отображаться внизу списка
    // Возможные варианты:
    // g-wb — устройства Wiren Board
    // g-wb-old — устаревшие устройства Wiren Board
    // g-adapter — адаптеры протоколов
    // g-climate-sensor — датчики климата
    // g-level — датчики уровня
    // g-dimmer — диммеры
    // g-air-conditioning — кондиционеры
    // g-climate-control — контроллеры вентиляции и климата
    // g-refrigeration — контроллеры холодильного оборудования
    // g-io — модули ввода-вывода
    // g-relay — модули реле
    // g-curtain — моторы для штор / электрокарнизы
    // g-control-panel — панели управления
    // g-water-meter — счетчики воды
    // g-heat-meter — счетчики тепла
    // g-power-meter — счетчики электроэнергии
    // g-thermostat — термостаты
    // g-motor-control — управление двигателями (преобразователи частоты)
    // g-custom — произвольные устройства

    &quot;group&quot;: &quot;g-wb&quot;,

    // Название типа устройства, которое будет отображаться в веб-конфигураторе.
    // Необязательный параметр. Если не указан, используется device_type.
    &quot;title&quot;: &quot;Device&quot;,

    // Признак того, что шаблон устарел, он не будет доступен для выбора при добавлении устройства в веб-конфигураторе
    // Также для такого шаблона будут игнорироваться возможные ошибки валидации на соответствие JSON схеме
    &quot;deprecated&quot;: true,

    // Список сигнатур устройств, которые поддерживает шаблон
    &quot;hw&quot;: [
        {
            // Сигнатура устройства WirenBoard
            &quot;signature&quot;: &quot;WBMR6C&quot;,

            // Версия прошивки, начиная с которой можно использовать данный шаблон
            // Этот параметр может отсутствовать, тогда шаблон подходит к любой версии прошивки
            &quot;fw&quot;: &quot;1.1.1&quot;
        }
    ],

    &quot;device&quot;: {
        // отображаемое имя устройства. Публикуется как
        // .../meta/name в MQTT
        &quot;name&quot;: &quot;New device&quot;,

        // Остальные параметры устройства, описанные выше в примере конфигурационного файла, кроме slave_id
        ...

        // Шаблон может иметь собственную секцию с настройками
        &quot;setup&quot;: [
            {
                &quot;title&quot;: &quot;s1&quot;,
                &quot;address&quot;: 20000,
                &quot;value&quot;: &quot;0xfff2&quot;
            },
            ...
        ],

        // Секция с описанием параметров устройства.
        // Значение параметра можно задать в файле конфигурации или через веб-конфигуратор
        &quot;parameters&quot;: [
            {
                // Имя параметра, которе будет использовано в конфигурационном файле
                &quot;id&quot;: &quot;param1&quot;,

                // Название параметра в веб-конфигураторе
                &quot;title&quot;: &quot;s22&quot;,

                // Адрес регистра параметра
                &quot;address&quot;: 9992,

                // Адрес регистра параметра только для записи (задается при необходимости).
                // Если задан, то чтение параметра производится по адресу, указанному в &quot;address&quot;,
                // а запись — по адресу, указанному в &quot;write_address&quot;.
                // При этом, если параметр &quot;address&quot; не указывать, то будет доступна только запись по адресу в &quot;write_address&quot;.
                &quot;write_address&quot;: 9995

                // Тип регистра
                &quot;reg_type&quot; : &quot;input&quot;,

                // Формат регистра
                &quot;format&quot;: &quot;s8&quot;,

                // Список возможных значений
                &quot;enum&quot;: [1, 2, 3],

                // Надписи в списке выбора в веб-конфигураторе
                &quot;enum_titles&quot;: [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;],

                // Значение по умолчанию в веб-конфигураторе
                &quot;default&quot;: 2,

                // Минимально возможное значение
                &quot;min&quot;: 1,

                // Максимально возможное значение
                &quot;max&quot;: 3,

                // Коэффициент, на который делится значение параметра перед записью в регистр
                &quot;scale&quot;: 2,

                // Значение, которое прибавляется к значению параметра перед записью в регистр
                &quot;offset&quot;: 10,

                // Этот параметр должен быть обязательно задан в wb-mqtt-serial.conf
                &quot;required&quot;: true,

                // Порядок отображения параметра в веб-конфигураторе
                &quot;order&quot;: 1,

                // Группа, к которой относится параметр
                &quot;group&quot;: &quot;group1&quot;,

                // Условие, при выполнении которого, значение параметра будет записано в устройство
                // В состав условия могут входить целые числа, названия других параметров,
                // операции сравнения (&gt;, &lt;, &gt;=, &lt;=, ==, !=), логические операции (&amp;&amp;, ||) и функция isDefined.
                // При вычислении условия вместо имён параметров подставляются их значения из конфигурационного файла.
                // Если какой-то параметр из условия не задан в конфигурационном файле,
                // то операции сравнения (&gt;, &lt;, &gt;=, &lt;=, ==) с ним возвращают false, операция проверки неравенства (!=) - возвращает true.
                // Функция isDefined позволяет определить задан ли параметр в конфигурационном файле
                // Условие также определяет доступность параметра для редактирования в интерфейсе веб-конфигуратора
                &quot;condition&quot;: &quot;isDefined(param1)&amp;&amp;(param2==1)||(param3&gt;5)&quot;,

                // Признак того, что значение параметра не записывается в регистры устройства.
                // Может быть использовано для организации настроек в веб-конфигураторе.
                // В зависимости от значения будут отображены только нужные каналы и параметры.
                // В дальнейшем значения таких параметров будет читаться из устройств.
                &quot;readonly&quot;: true
            }
        ],

        // Список каналов
        &quot;channels&quot;: [
            // Пример канала, описывающий данные одного регистра
            {
                &quot;name&quot;: &quot;Temperature&quot;,
                &quot;reg_type&quot;: &quot;input&quot;,
                &quot;format&quot;: &quot;s32&quot;,
                &quot;address&quot;: &quot;0x0504&quot;,
                &quot;group&quot;: &quot;group1&quot;,

                // Условие, при выполнении которого, канал будет доступен для опроса
                &quot;condition&quot;: &quot;(param2==1)||(param3==5)&quot;
            },
            ...
        ],

        // Группы используются для удобной организации интерфейса веб-конфигуратора
        // и не влияют на структуру конфигурационного файл
        &quot;groups&quot;: [
            // Описание группы
            {
                // Уникальное имя группы, отображается в веб-конфигураторе
                &quot;title&quot;: &quot;Group 1&quot;,

                // Идентификатор группы
                &quot;id&quot;: &quot;group1&quot;,

                // Группа вложена в другую группу
                &quot;group&quot;: &quot;group2&quot;,

                // Описание группы
                &quot;description&quot;: &quot;Group description&quot;
            },
            ...
        ]
    }
}
</code></pre></div></td></tr></table></div>
<h3 id="_7">Перевод названий параметров устройств<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>Переводы используются в веб-конфигураторе для формирования интерфейса настройки устройств. Они описываются в шаблоне устройства в секции <code>translations</code>. Эта секция содержит переводы строк, которые могут встречаться в названиях параметров, отчетах об ошибках и т.д. Секция содержит набор параметров <code>"Язык": "Строка на английском": "Перевод"</code>.
Например:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code>{
    &quot;device_type&quot;: &quot;Example&quot;,
    &quot;title&quot;: &quot;Device&quot;,
    &quot;device&quot;: {
        &quot;name&quot;: &quot;Example device&quot;,
        &quot;channels&quot;: [
            {
                &quot;name&quot;: &quot;Temperature&quot;,
                &quot;reg_type&quot;: &quot;holding&quot;,
                &quot;address&quot;: 1,
                &quot;group&quot;: &quot;group 1&quot;
            }
        ],
        &quot;parameters&quot;: [
            {
                &quot;id&quot;: &quot;timeout&quot;,
                &quot;title&quot;: &quot;Timeout&quot;,
                &quot;address&quot;: 9992,
                &quot;group&quot;: &quot;group 1&quot;
            }
        ],
        &quot;groups&quot;: [
            {
                &quot;title&quot;: &quot;Group 1&quot;,
                &quot;id&quot;: &quot;group1&quot;,
                &quot;order&quot;: 3
            }
        ],
        &quot;translations&quot;: {
            &quot;ru&quot;: {
                &quot;Device&quot;: &quot;Устройство&quot;,
                &quot;Temperature&quot;: &quot;Температура&quot;,
                &quot;Timeout&quot;: &quot;Задержка&quot;,
                &quot;Group 1&quot;: &quot;Группа 1&quot;
            }
        }
    }
}
</code></pre></div></td></tr></table></div>
<h2 id="_8">Особенности работы драйвера<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="_9">Таймауты и количество неудачных циклов<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>Циклом опроса устройства считается внутренний цикл опроса драйвера внутри которого был опрошен хотя бы один из регистров данного устройства.</p>
<p><code>connection_timeout_ms</code> и <code>connection_max_fail_cycles</code> - указываются для порта типа TCP или MODBUS TCP. Необходимы для автоматического восстановления соединения. Если в течение <code>connection_timeout_ms</code> и более чем <code>connection_max_fail_cycles</code> подряд циклов опроса все устройства были отключены, соединение сбрасывается и происходит попытка переподключения. Можно использовать только один тип таймаута, для этого нужно выставить значение 0 другому типу таймаута (например, чтобы осуществлять обнаружение разрыва соединения только по времени, нужно выставить "<code>connection_max_fail_cycles</code>": 0). При большом количестве устройств на порту, длительность цикла опроса устройств может сильно варьироваться в зависимости от числа отвечающих устройств, т.к. они вносят дополнительные задержки на ожидание ответа, поэтому если нужно обозначить минимальное количество циклов опроса до отключения вне зависимости от числа устройств, можно использовать вариант <code>connection_max_fail_cycles</code>. При использовании только <code>connection_timeout_ms</code>, на количество попыток обращения к порту будут влиять другие временные настройки, такие как <code>poll_interval</code>, <code>guard_interval</code>, <code>response_timeout</code> и при их изменении возможно придется подстраивать значение connection_timeout_ms. Если же нужно исключить срабатывание таймаута на каких-то кратковременных случайных ошибках, которые не стоит считать обрывом связи, то нужно использовать <code>connection_timeout_ms</code>. При использовании параметров вместе, таймаут сработает только когда выполнятся оба условия, т.е. пройдет нужное время и количество циклов.</p>
<p><code>device_timeout_ms</code> и <code>device_max_fail_cycles</code> - указываются для устройства. По семантике аналогичен <code>connection_timeout_ms</code> и <code>connection_max_fail_cycles</code>, но только для устройства. Нужен для выявления отключения устройства для повторной отправки setup - секции при переподключении. Если в течение <code>device_timeout_ms</code> и более чем <code>device_max_fail_cycles</code> подряд циклов ни один из опрошенных регистров не был успешно прочитан, то устройство будет помечено как отсоединенное и будет опрашиваться в ограниченном режиме, т.е. при наличии у устройства setup - секции, драйвер будет пытаться записать ее, а в противном случае, будет пытаться опросить устройство. Если первое обращение к устройству в ограниченном режиме закончилось ошибкой, драйвер считает что устройство все еще отключено и больше не опрашивает его в этом цикле. Это позволяет тратить меньше времени на отключенные устройства. Первый успешный запрос к устройству будет расценен как переподключение устройства.</p>
<h4 id="_10">Значения по умолчанию<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">Параметр</th>
<th style="text-align: right;">Значение</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">device_timeout_ms</td>
<td style="text-align: right;">3000</td>
</tr>
<tr>
<td style="text-align: left;">device_max_fail_cycles</td>
<td style="text-align: right;">2</td>
</tr>
<tr>
<td style="text-align: left;">connection_timeout_ms</td>
<td style="text-align: right;">5000</td>
</tr>
<tr>
<td style="text-align: left;">connection_max_fail_cycles</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
<h4 id="tcp-modbus-tcp">Замечания для TCP или MODBUS TCP порта<a class="headerlink" href="#tcp-modbus-tcp" title="Permanent link">&para;</a></h4>
<p>При использовании TCP мостов, драйвер не видит разницы между двумя ситуациями:</p>
<ul>
<li>физически отключены все устройства от моста</li>
<li>разорвано TCP соединение с мостом</li>
</ul>
<p>так как в обоих случаях никаких данных драйвер не получает. Поэтому, в этом случае, connection_timeout для порта и device_timeout для устройств истекают одновременно.</p>
<p>Это влечет за собой периодический сброс TCP соединения и переподключение к мосту в ситуации когда физически отключены все устройства от моста, хотя с самим TCP соединением проблем нет.</p>
<p>В ситуации когда хотя бы одно из опрашиваемых устройств подключено к мосту без проблем с TCP соединением, TCP подключение не будет сбрасываться, а таймаут будет отсчитываться только для отключенных устройств.</p>
<h3 id="_11">Диаграмма таймаутов цикла опроса<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><img alt="Диаграмма таймаутов цикла опроса" src="doc/timeouts.svg" /></p>
<h3 id="-">Объединенное чтение регистров и его авто-отключение<a class="headerlink" href="#-" title="Permanent link">&para;</a></h3>
<p>Для ускорения опроса регистров устройств, драйвер объединяет чтение соседних регистров в один запрос (см. <code>max_reg_hole</code>, <code>max_bit_hole</code>), однако, считывание т.н. "пустых" регистров может привести к ошибкам на некоторых устройствах. Как только драйвер получает от устройства ошибку при считывании множества регистров, среди которых есть пустые, которая могла быть вызвана чтением пустых регистров (для Modbus: <code>ILLEGAL_DATA_ADDRESS</code>, <code>ILLEGAL_DATA_VALUE</code>), драйвер перестает объединённо считывать эти регистры.
Устройства Wiren Board поддерживают <a href="https://wirenboard.com/wiki/Modbus#%D0%A0%D0%B5%D0%B6%D0%B8%D0%BC_%D1%81%D0%BF%D0%BB%D0%BE%D1%88%D0%BD%D0%BE%D0%B3%D0%BE_%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D1%8F_%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%BE%D0%B2">режим сплошного чтения регистров</a>. Для его активации надо установить параметр <code>enable_wb_continuous_read</code> в шаблоне или настройках устройства.</p>
<h3 id="_12">Список сконфигурированных портов<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>Список портов можно получить, выполнив MQTT RPC запрос <code>wb-mqtt-serial/ports/Load</code>. Он возвращает JSON массив следующего вида:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code>[
   {
       &quot;baud_rate&quot;: 9600,
       &quot;data_bits&quot;: 8,
       &quot;parity&quot;: &quot;N&quot;,
       &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;,
       &quot;stop_bits&quot;: 1
   },
   {
       &quot;address&quot;: &quot;127.0.0.1&quot;,
       &quot;port&quot;: 2000
   },
   ...
]
</code></pre></div></td></tr></table></div>
<h3 id="_13">Прямое чтение и запись в порт<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>Существует возможность выполнить запись и чтение из порта посредством MQTT RPC запроса. Выполнение запроса встраивается в цикл опроса устройств таким образом, что запрос выполнится с высоким приоритетом сразу после окончания текущего цикла опроса.
Для выполнения запроса необходимо отправить в топик <code>wb-mqtt-serial/port/Load/client_id</code>, где client_id - произвольное имя клиента, посылающего запрос, сообщение типа JSON со следующими параметрами:</p>
<h4 id="_14">Параметры<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Тип</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>msg</code></td>
<td>обязательный</td>
<td></td>
<td>текстовое сообщение для отправки в порт</td>
</tr>
<tr>
<td><code>response_size</code></td>
<td>обязательный</td>
<td></td>
<td>количество байт, которое нужно прочитать из порта</td>
</tr>
<tr>
<td><code>format</code></td>
<td>опциональный</td>
<td><code>STR</code></td>
<td>при указании значения <code>STR</code> содержимое параметра <code>msg</code> интерпретируется как строка и передается в порт как есть. При указании значения <code>HEX</code> содержимое <code>msg</code> интерпретируется как шестнадцатеричная строка и перед отправкой в порт преобразуется в массив байт</td>
</tr>
<tr>
<td><code>response_timeout</code></td>
<td>опциональный</td>
<td>500 ms</td>
<td>таймаут чтения первого байта в миллисекундах</td>
</tr>
<tr>
<td><code>frame_timeout</code></td>
<td>опциональный</td>
<td>20 ms</td>
<td>таймаут чтения каждого последующего байта в миллисекундах</td>
</tr>
<tr>
<td><code>total_timeout</code></td>
<td>опциональный</td>
<td>10000ms</td>
<td>таймаут выполнения RPC-запроса в миллисекундах</td>
</tr>
</tbody>
</table>
<h5 id="_15">Обязательные параметры запроса в последовательный порт<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>path</code></td>
<td>путь к последовательному порту, в который будет отправлено сообщение</td>
</tr>
<tr>
<td><code>baud_rate</code></td>
<td>скорость порта</td>
</tr>
<tr>
<td><code>parity</code></td>
<td>чётность - N, O или E</td>
</tr>
<tr>
<td><code>data_bits</code></td>
<td>количество бит данных</td>
</tr>
<tr>
<td><code>stop_bits</code></td>
<td>количество стоп-бит</td>
</tr>
</tbody>
</table>
<h5 id="tcp">Обязательные параметры запроса в TCP порт<a class="headerlink" href="#tcp" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ip</code></td>
<td>IP-адрес клиента, которому будет отправлено сообщение</td>
</tr>
<tr>
<td><code>port</code></td>
<td>номер порта на указанном адресе клиента</td>
</tr>
</tbody>
</table>
<p>В качестве ответа в топике <code>wb-mqtt-serial/port/Load/client_id/reply</code> будет опубликовано сообщение типа JSON со следующими параметрами:</p>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>result</code></td>
<td>В случае неуспешного выполнения запроса содержит <code>null</code>. В случае успешного выполнения содержит в себе единственное поле <code>response</code>. В случае, если при запросе в поле <code>format</code> было указано <code>STR</code>, значение поля представляет собой набор символов, полученных из порта, и передается запрашивающей стороне как есть. В случае значения <code>HEX</code> содержимое поля представляет собой шестнадцатеричную строку</td>
</tr>
<tr>
<td><code>id</code></td>
<td>Порядковый номер запроса</td>
</tr>
<tr>
<td><code>error</code></td>
<td>В случае успешного выполнения запроса содержит значение <code>null</code>. В ином случае содержит параметры, приведенные в таблице ниже</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>message</code></td>
<td>Строка с кратким описанием ошибки</td>
</tr>
<tr>
<td><code>code</code></td>
<td>Код ошибки. Возможные коды ошибок приведены в таблице ниже</td>
</tr>
<tr>
<td><code>data</code></td>
<td>Строка с подробным описанием места и условий возникновения ошибки</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Код ошибки</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-32700</code></td>
<td>Ошибка разбора JSON запроса</td>
</tr>
<tr>
<td><code>-32000</code></td>
<td>Ошибка выполнения запроса</td>
</tr>
<tr>
<td><code>-32600</code></td>
<td>Таймаут выполнения запроса</td>
</tr>
</tbody>
</table>
<p>Примеры выполнения запросов:</p>
<ol>
<li>
<p>Успешное выполнение запроса:
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;total_timeout&quot;: 10000, &quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;}, &quot;id&quot; : 1}
RPC Client &lt;- {&quot;error&quot;:null,&quot;id&quot;:1,&quot;result&quot;:{&quot;response&quot;:&quot;1605000aff00af1f&quot;}}
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>Ошибка разбора JSON запроса
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;&quot;path&quot;: &quot;/dev/ttyRS485-34534&quot;, &quot;response_size&quot;: 8, &quot;total_timeout&quot;: 10000, &quot;msg&quot;: &quot;1605000aff00af1f&quot;, &quot;format&quot;: &quot;HEX&quot;}, &quot;id&quot;: 1}
RPC Client &lt;-{&quot;error&quot;:{&quot;code&quot;:-32700,&quot;message&quot;:&quot;Parse error&quot;},&quot;id&quot;:null}
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>Ошибка выполнения запроса (ошибка ввода-вывода)
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;total_timeout&quot;: 10000, &quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;}, &quot;id&quot; : 1}
RPC Client &lt;- {&quot;error&quot;:{&quot;code&quot;:-32000,&quot;data&quot;:&quot;Port IO error: request timed out&quot;,&quot;message&quot;:&quot;Server error&quot;},&quot;id&quot;:1,&quot;result&quot;:null}
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>Ошибка выполнения запроса (запрос в несуществующий порт)
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;total_timeout&quot;: 10000, &quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-31337&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;}, &quot;id&quot; : 1}
RPC Client -&gt; {&quot;error&quot;:{&quot;code&quot;:-32000,&quot;data&quot;:&quot;Requested port doesn&#39;t exist&quot;,&quot;message&quot;:&quot;Server error&quot;},&quot;id&quot;:1,&quot;result&quot;:null}
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>Таймаут выполнения запроса (слишком малое значение таймаута)
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;, &quot;total_timeout&quot;: 10}, &quot;id&quot; : 1}
RPC Client &lt;- {&quot;error&quot;:{&quot;code&quot;:-32600,&quot;data&quot;:&quot;Request handler is not responding @ src/rpc_handler.cpp:179&quot;,&quot;message&quot;:&quot;Request timeout&quot;},&quot;id&quot;:1,&quot;result&quot;:null}
</code></pre></div></td></tr></table></div></p>
</li>
</ol>
<h3 id="_16">Прямая установка параметров связи устройства<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>Существует возможность выполнить прямую установку параметров связи Modbus-устройства Wiren Board с помощью MQTT RPC запроса. Выполнение запроса встраивается в цикл опроса устройств таким образом, что запрос выполнится с высоким приоритетом сразу после окончания текущего цикла опроса.
Для выполнения запроса необходимо отправить в топик <code>wb-mqtt-serial/port/Setup/client_id</code>, где client_id - произвольное имя клиента, посылающего запрос, сообщение типа JSON со следующими параметрами:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="c1">// Путь к последовательному порту, в который будет отправлено сообщение</span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/dev/ttyRS485-1&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="nt">&quot;items&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Адрес устройства</span>
<span class="w">            </span><span class="nt">&quot;slave_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span>

<span class="w">             </span><span class="c1">// Скорость порта</span>
<span class="w">            </span><span class="nt">&quot;baud_rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">115200</span><span class="p">,</span>

<span class="w">            </span><span class="c1">// Чётность - N, O или E</span>
<span class="w">            </span><span class="nt">&quot;parity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;N&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="c1">// Количество бит данных</span>
<span class="w">            </span><span class="nt">&quot;data_bits&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>

<span class="w">            </span><span class="c1">// Количество стоп-бит</span>
<span class="w">            </span><span class="nt">&quot;stop_bits&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>

<span class="w">            </span><span class="c1">// Настройки, которые будут применены к устройству</span>
<span class="w">            </span><span class="nt">&quot;cfg&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Скорость порта</span>
<span class="w">                </span><span class="nt">&quot;baud_rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">115200</span><span class="p">,</span>

<span class="w">                </span><span class="c1">// Чётность, задаётся числом</span>
<span class="w">                </span><span class="c1">//   N - 0,</span>
<span class="w">                </span><span class="c1">//   O - 1,</span>
<span class="w">                </span><span class="c1">//   E - 2</span>
<span class="w">                </span><span class="nt">&quot;parity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">                </span><span class="c1">// Количество стоп-бит</span>
<span class="w">                </span><span class="nt">&quot;stop_bits&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="err">...</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
При успешном выполнение запроса возвращается ответ следующей структуры:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">ID_ЗАПРОСА</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
Ответы с ошибками аналогичны прямому чтению и записи в порт.</p>
<h2 id="_17">Протоколы<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<h3 id="_18">Поддержка различных протоколов на одной шине<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>Возможно использование устройств, работающих по различным протоколам, на одном порту. При этом следует учитывать особенности конкретных протоколов.</p>
<p>Например, фреймы устройств Uniel начинаются с байта 0xff, устройств ИВТМ - с байта 0x24 ('$'), в случае же протоколов Modbus, Меркурий 230 и Милур первым байтом фрейма является идентификатор slave, поэтому при совмещении подобных устройств следует внимательно подходить к выбору slave id - у устройств Милур, например, slave id по умолчанию равен 0xff, что приводит к конфликту с устройствами Uniel.</p>
<p>Устройства Милур требуют дополнительных задержек при опросе (заданы в шаблоне) и при использовании на одной шине с другими устройствами могут снизить скорость опроса.</p>
<p>Некоторые устройства, поддерживающие дополнительные протоколы, могут оказаться несовместимыми с теми или иными протоколами на той же шине, например, было замечено, что устройства с поддержкой протокола A-BUS производства "Разумный дом" не могут работать на одной шине с устройствами Uniel.</p>
<p>Работа устройств ИВТМ на одной шине с устройствами, работающими по другим протоколам, не проверялась. Проверенная рабочая комбинация: Modbus + Milur (slave_id != 0xff) + Uniel на одной шине.</p>
<h3 id="modbus">Modbus<a class="headerlink" href="#modbus" title="Permanent link">&para;</a></h3>
<h3 id="_19">Широковещательные сообщения<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>Протоколы <code>Меркурий 230</code>, <code>Энергомера ГОСТ МЭК 61107</code>,
<code>НЕВА МТ 32х ГОСТ МЭК 61107</code> поддерживают отправку широковещательных сообщений, если не указывать идентификатор устройства, или указать вместо него пустую строку. Это можно использовать, если на шине только одно устройство такого типа, и его адрес неизвестен. При этом нельзя на одном порту одновременно использовать широковещательные сообщения <code>Энергомера ГОСТ МЭК 61107</code> и <code>НЕВА МТ 32х ГОСТ МЭК 61107</code>.</p>
<h3 id="61107">Энергомера ГОСТ МЭК 61107<a class="headerlink" href="#61107" title="Permanent link">&para;</a></h3>
<p>При любых настройках порта фактический обмен с счётчиками происходит в режиме 9600 7E1, в соответствии с МЭК 61107.</p>
<p>Реализованы 2 режима обмена:</p>
<ul>
<li>"быстрого группового чтения" без открытия сессии (<code>"device_type": "energomera_iec"</code>);</li>
<li>ГОСТ МЭК 61107 Mode C (<code>"device_type": "energomera_iec_mode_c"</code>).</li>
</ul>
<p>Режим "быстрого группового чтения" специфичен для протокола счётчиков Энергомера и не соответствует стандарту ГОСТ МЭК 61107. Список параметров, доступных для чтения, приведён в Таблице 11 <a href="http://www.energomera.ru/documentations/product/ce301_303_rp.pdf">руководства пользователя счётчиков CE301/303</a>. Поддерживаются только параметры с пустым запросом и с запросом-битовой маской.</p>
<p>Параметры кодируются в адресе регистра как <code>0xAABBCC</code>, где <code>AA</code> - "тип" параметра, <code>BB</code> - "уточнение", <code>СС</code> - номер бита из битовой маски запроса.</p>
<p>Режим ГОСТ МЭК 61107 Mode C соответствует стандарту, список параметров, доступных для чтения, можно найти в руководствах конкретных счётчиков. Параметры кодируются в адресе регистра строкой, она должна содержать полный запрос, включая <code>(</code> и <code>)</code>. Например, суммарные показания энергии для счётчика Энергомера СЕ102М будут иметь адрес <code>ET0PE(1)</code>.</p>
<h3 id="32-61107">НЕВА МТ 32х ГОСТ МЭК 61107<a class="headerlink" href="#32-61107" title="Permanent link">&para;</a></h3>
<p>При любых настройках порта фактический обмен с счётчиками происходит в режиме 9600 7E1, в соответствии с МЭК 61107.</p>
<p>Реализован режим чтения параметров по OBIS-кодам (<a href="https://en.wikipedia.org/wiki/IEC_62056">IEC 62056-6-1:2017</a>)</p>
<p>OBIS-коды кодируются в адресе регистра следующим образом:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>0xCCDDEEFF
</code></pre></div></td></tr></table></div>
<p>где <code>CC</code> - группа С, <code>DD</code> - группа D, <code>EE</code> - группа E, <code>FF</code> - группа F OBIS-кода.</p>
<h3 id="dlmscosem">DLMS/COSEM и СПОДЭС<a class="headerlink" href="#dlmscosem" title="Permanent link">&para;</a></h3>
<p>Физический адрес устройства задаётся в параметре <code>slave_id</code>. Опрашивается логическое устройство с адресом 1.
Адрес клиента задаётся в параметре <code>dlms_client_address</code>, если он не задан, используется адрес 16 (публичный клиент).
Тип аутентификации задаётся в параметре <code>dlms_auth</code>.</p>
<p>Коммуникационный профиль задаётся в параметре <code>dlms_interface</code>, если он не задан, используется протокол HDLC. Поддерживается адресация по логическому имени объектов.</p>
<p>Данные читаются по OBIS-кодам (<a href="https://en.wikipedia.org/wiki/IEC_62056">IEC 62056-6-1:2017</a>). OBIS-коды записываются в адресе регистра строкой, например <code>0.0.96.9.0.255</code>. Поддерживается автоматический разбор данных от объектов с классом <code>register</code>(class_id = 3), остальные классы не поддерживаются.</p>
<p>Реализован анализ доступных объектов устройства и генерация шаблона. Для этого надо остановить <code>wb-mqtt-serial</code> и запустить его из командной строки с параметром <code>-G</code>. Сгенерированный шаблон будет записан в каталог <code>/etc/wb-mqtt-serial.conf.d/templates</code>.</p>
<p>Пример команд для генерации шаблона:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># systemctl stop wb-mqtt-serial</span>
<span class="c1"># wb-mqtt-serial -G print_all,/dev/ttyMOD3,9600-8-N-1,dlms_hdlc:75,32,low,12345678</span>
<span class="c1"># systemctl start wb-mqtt-serial</span>
</code></pre></div></td></tr></table></div>
<p>Подробнее об опциях параметра <code>-G</code> можно узнать во встроенной справке <code>wb-mqtt-serial -G help</code>.</p>
<h3 id="somfy-sdn">Somfy SDN<a class="headerlink" href="#somfy-sdn" title="Permanent link">&para;</a></h3>
<p>Тип мотора(<code>node type</code>) можно задать через параметр устройства <code>node_type</code>. По умолчанию используется Sonesse 30.
Для организации отправки команд можно использовать канал с типом регистра <code>command</code>.</p>
<p>В этом случае заголовок пакета (<code>MSG</code>) задаётся в адресе регистра. Число, записываемое в такой регистр должно содержать длину в младшем байте. Например, <code>0x03020103</code> будет означать, что в команду будет добавлено 3 байта: 0x01, 0x02, 0x03.</p>
<p>Для организации запроса статуса или значений настроек можно использовать канал с типом регистра <code>param</code>. В этом случае заголовок запроса (<code>MSG</code>) задаётся в адресе регистра. А заголовок ответа - в параметре <code>response_header</code>. Поддерживается возможность указать смещение и длину данных в ответе.
Для организации записи настроек надо указать в параметре <code>write_address</code> заголовок setup-пакета.</p>
<h3 id="windeco">WinDeco<a class="headerlink" href="#windeco" title="Permanent link">&para;</a></h3>
<p>Для организации отправки команд можно использовать канал с типом регистра <code>command</code>. В этом случае код команды задаётся в адресе регистра.</p>
<h3 id="dooya">Dooya<a class="headerlink" href="#dooya" title="Permanent link">&para;</a></h3>
<p>Для организации отправки команд управления можно использовать канал с типом регистра <code>command</code>.
Для команды без параметров адрес данных задаётся в адресе регистра.
Для команды с параметром адрес данных задаётся во втором байте адреса регистра, сами данные - в младшем байте.
Для организации доступа к настройкам можно использовать канал с типом регистра <code>param</code>.
Адрес данных задаётся в адресе регистра.</p>
<h3 id="dauerhaft">Dauerhaft<a class="headerlink" href="#dauerhaft" title="Permanent link">&para;</a></h3>
<p>Адрес шторы задается в формате: <code>0x&lt;ID мотора (1 байт)&gt;&lt;ID канала (младший байт)&gt;&lt;ID канала (старший байт)&gt;</code>.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Тип регистра</th>
<th style="text-align: center;">Адрес</th>
<th style="text-align: center;">R/W</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">command</td>
<td style="text-align: center;">код команды (0xdd,0xcc,0xee,0x0d,0x0e,0xaa,0xa6,0x01,0x02,0x03,0x04)</td>
<td style="text-align: center;">W</td>
</tr>
<tr>
<td style="text-align: center;">position</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td style="text-align: center;">param</td>
<td style="text-align: center;">код команды (0xd9,0xd2,0xda,0xd6,0xd7,0xd8)</td>
<td style="text-align: center;">W</td>
</tr>
<tr>
<td style="text-align: center;">status</td>
<td style="text-align: center;"><code>&lt;0xcc00,0xcaca,0xcbcb&gt;:&lt;shift&gt;:&lt;width&gt;</code></td>
<td style="text-align: center;">R</td>
</tr>
<tr>
<td style="text-align: center;">zonebit</td>
<td style="text-align: center;">номер бита (0-7)</td>
<td style="text-align: center;">RW</td>
</tr>
</tbody>
</table>
<h3 id="200">Меркурий 200<a class="headerlink" href="#200" title="Permanent link">&para;</a></h3>
<p>Типы регистров:</p>
<ul>
<li>param8 - восьмибитное число</li>
<li>param16 - 16-тибитное число</li>
<li>param24 - 24-тибитное число</li>
<li>param32 - 32-тибитное число</li>
</ul>
<p>Код команды задаётся в адресе регистра, при этом младший байт задаёт смещение данных в ответе.</p>
<h3 id="230">Меркурий 230<a class="headerlink" href="#230" title="Permanent link">&para;</a></h3>
<p>Типы регистров:</p>
<ul>
<li>array - массив из четырёх 2-х байтных элементов, полученный в ответ на запрос с кодом 0x05</li>
<li>array12 - массив из трех 2-х байтных элементов, полученный в ответ на запрос с кодом 0x05</li>
<li>param - значение, полученное в ответ на запрос с кодом 0x08</li>
<li>param_sign_active - значение активной мощности со знаком, полученное в ответ на запрос с кодом 0x08</li>
<li>param_sign_reactive - значение реактивной мощности со знаком, полученное в ответ на запрос с кодом 0x08</li>
<li>param_sign_ignore - значение мощности без знака, полученное в ответ на запрос с кодом 0x08</li>
<li>param_be - значение с порядком байт big endian, полученное в ответ на запрос с кодом 0x08</li>
</ul>
<p>Для типов <code>array</code> и <code>array12</code> адрес регистра кодирует параметры запроса следующим образом:
 - младшие 4 бита младшего байта адреса - порядковый номер элемента в массиве ответа
 - старшие 4 бита младшего байта - номер месяца
 - младшие 4 бита старшего байта - номер массива
 - старшие 4 бита старшего байта - номер тарифа</p>
<p>Для остальных типов старший байт адреса регистра кодирует номер параметра, младший - номер подпараметра</p>
<h3 id="device_type">Таблица шаблонов device_type<a class="headerlink" href="#device_type" title="Permanent link">&para;</a></h3>
<p>Сгруппирована по протоколам.</p>
<p><strong>Modbus-RTU</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center;">Device</th>
<th style="text-align: center;">device_type</th>
<th style="text-align: center;">id_prefix</th>
<th style="text-align: center;">name_prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">"Разумный дом" четырёхканальный диммер светодиодов DDL4</td>
<td style="text-align: center;">DDL24</td>
<td style="text-align: center;">ddl24</td>
<td style="text-align: center;">DDL24</td>
</tr>
<tr>
<td style="text-align: center;">"Разумный дом" релейный модуль DRB88</td>
<td style="text-align: center;">DRB88</td>
<td style="text-align: center;">drb88</td>
<td style="text-align: center;">DRB88</td>
</tr>
<tr>
<td style="text-align: center;">RD DDL04R LED Strip Dimmer</td>
<td style="text-align: center;">DDL04R</td>
<td style="text-align: center;">ddl04r</td>
<td style="text-align: center;">DDL04R</td>
</tr>
<tr>
<td style="text-align: center;">"ICP DAS" модуль управления освещением LC-103</td>
<td style="text-align: center;">LC-103</td>
<td style="text-align: center;">lc-103</td>
<td style="text-align: center;">LC-103</td>
</tr>
<tr>
<td style="text-align: center;">"Разумный дом" MSU24</td>
<td style="text-align: center;">MSU24</td>
<td style="text-align: center;">msu24</td>
<td style="text-align: center;">MSU24</td>
</tr>
<tr>
<td style="text-align: center;">"Разумный дом" MSU21</td>
<td style="text-align: center;">MSU21</td>
<td style="text-align: center;">msu21</td>
<td style="text-align: center;">MSU21</td>
</tr>
<tr>
<td style="text-align: center;">"Разумный дом" MSU34+TLP</td>
<td style="text-align: center;">MSU34</td>
<td style="text-align: center;">msu34tlp</td>
<td style="text-align: center;">MSU34+TLP</td>
</tr>
<tr>
<td style="text-align: center;">"Разумный дом" MSU34+TLHP</td>
<td style="text-align: center;">MSU34TLHP</td>
<td style="text-align: center;">msu34tlhp</td>
<td style="text-align: center;">MSU34+TLHP</td>
</tr>
<tr>
<td style="text-align: center;">"ICP DAS" модуль ввода-вывода TM-P3R3</td>
<td style="text-align: center;">TM-P3R3</td>
<td style="text-align: center;">TM-P3R3</td>
<td style="text-align: center;">tmp3r3</td>
</tr>
<tr>
<td style="text-align: center;">"Kvadro" модуль подключения термометров 1-wire</td>
<td style="text-align: center;">kvadro-1wire</td>
<td style="text-align: center;">kvadro-1wire</td>
<td style="text-align: center;">Kvadro 1-Wire</td>
</tr>
<tr>
<td style="text-align: center;">PD561Z-9SY счётчик электроэнергии</td>
<td style="text-align: center;">PD561Z</td>
<td style="text-align: center;">pd561z</td>
<td style="text-align: center;">pd561z</td>
</tr>
<tr>
<td style="text-align: center;">SDM220 счётчик электроэнергии</td>
<td style="text-align: center;">SDM220</td>
<td style="text-align: center;">sdm220</td>
<td style="text-align: center;">sdm220</td>
</tr>
<tr>
<td style="text-align: center;">SDM120 счётчик электроэнергии</td>
<td style="text-align: center;">SDM120</td>
<td style="text-align: center;">sdm120</td>
<td style="text-align: center;">sdm120</td>
</tr>
<tr>
<td style="text-align: center;">WELLPRO WP8028ADAM (8DI/8DO)</td>
<td style="text-align: center;">WP8028ADAM</td>
<td style="text-align: center;">wp8028adam</td>
<td style="text-align: center;">WP8028ADAM</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board RGB-диммер WB-MRGB</td>
<td style="text-align: center;">WB-MRGB</td>
<td style="text-align: center;">WB-MRGB</td>
<td style="text-align: center;">wb-mrgb</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board Релейный модуль WB-MRM2</td>
<td style="text-align: center;">WB-MRM2</td>
<td style="text-align: center;">WB-MRM2</td>
<td style="text-align: center;">wb-mrm2</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board Релейный модуль WB-MR11</td>
<td style="text-align: center;">WB-MR11</td>
<td style="text-align: center;">WB-MR11</td>
<td style="text-align: center;">wb-mr11</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board Релейный модуль WB-MR14</td>
<td style="text-align: center;">WB-MR14</td>
<td style="text-align: center;">WB-MR14</td>
<td style="text-align: center;">wb-mr14</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board модуль дискретных/счётных входов WB-MCM16</td>
<td style="text-align: center;">WB-MCM16</td>
<td style="text-align: center;">WB-MCM16</td>
<td style="text-align: center;">wb-mcm16</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board Датчик WB-MS-THLS / WB-MSW-THLS</td>
<td style="text-align: center;">WB-MS-THLS</td>
<td style="text-align: center;">wb-ms-thls</td>
<td style="text-align: center;">WB-MS-THLS</td>
</tr>
<tr>
<td style="text-align: center;">Wiren Board Датчик WB-MS-THLS / WB-MSW-THLS  (fw. v.2)</td>
<td style="text-align: center;">WB-MS-THLS v.2</td>
<td style="text-align: center;">wb-ms-thls</td>
<td style="text-align: center;">WB-MS-THLS</td>
</tr>
<tr>
<td style="text-align: center;">Peacefair PZEM-016</td>
<td style="text-align: center;">PZEM-016</td>
<td style="text-align: center;">pzem</td>
<td style="text-align: center;">PZEM</td>
</tr>
</tbody>
</table>
<p><strong>Милур</strong>
|                     Device                     | device_type   | id_prefix | name_prefix      |
|:----------------------------------------------:|:-------------:|:---------:|:----------------:|
| Счётчик электроэнергии Милур-305               | milur305      | milur305  | Milur 305        |
| Счётчик электроэнергии Милур-105 (Милур-104)   | Milur 104/105 | milur105  | Milur 105        |</p>
<p><strong>Mercury 230</strong>
|                     Device                     | device_type | id_prefix      | name_prefix      |
|:----------------------------------------------:|:-----------:|:--------------:|:----------------:|
| Счётчик электроэнергии Меркурий-230            | mercury230  | mercury230ar02 | Mercury 230AR-02 |</p>
<p><strong>Uniel</strong>
|                     Device                     | device_type | id_prefix      | name_prefix      |
|:----------------------------------------------:|:-----------:|:--------------:|:----------------:|
| Модуль управления освещением UCH-M111RX        | UCH-M111RX  | uchm111rx      | UCH-M111RX 0808  |
| Модуль управления автоматикой UCH-M121RX       | UCH-M121RX  | uchm121rx      | UCH-M121RX 0808  |
| Диммер светодиодных ламп UCH-M141RC            | UCH-M141RC  | uchm141rc      | UCH-M141RC 0808  |</p>
<p><strong>ИВТМ</strong>
|                     Device                     | device_type | id_prefix      | name_prefix      |
|:----------------------------------------------:|:-----------:|:--------------:|:----------------:|
| Термогигрометр ИВТМ-7 М 3                      | IVTM-7M-3   | ivtm7m3        | IVTM-7M-3        |</p>
<p><strong>Пульсар</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Счётчик воды "Пульсар"                         | pulsar-water   | pulsar-water   |  Pulsar Water Meter   |
| Счётчик воды многоструйный "Пульсар-М"         | pulsar-m-water | pulsar-m-water |  Pulsar-M Water Meter |
| Счётчик тепла "Пульсар"                        | pulsar-heat    | pulsar-heat    |  Pulsar Heat Meter    |</p>
<p><strong>Энергомера МЭК 61107</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Энергомера CE301 счётчик активной электрической энергии трёхфазный                         | Energomera CE301/CE303   | energomera301   |  Energomera CE301   |
| Энергомера CE303 счётчик активной и реактивной электрической энергии трёхфазный                         | Energomera CE303   | energomera303   |  Energomera CE303   |</p>
<p><strong>НЕВА МТ 323/324</strong>
|                       Device                     | device_type   | id_prefix      | name_prefix   |
|:------------------------------------------------:|:-------------:|:--------------:|:-------------:|
| НЕВА МТ 323/324 трёхфазный многотарифный счётчик | NEVA MT 32x   | neva32x        |  NEVA MT 32x  |</p>
<p><strong>DLMS/COSEM, СПОДЭС</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Энергомера CE308 Z счетчик электроэнергии трехфазный многофункциональный | energomera_ce308_dlms   | energomera308   |  Energomera CE308   |
| Счётчик электроэнергии Меркурий 234 D          | mercury_234_dlms   | mercury234   |  Mercury 234   |</p>
<p><strong>Somfy SDN</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами Somfy SDN             | Somfy SDN      | somfy          |  Somfy SDN            |</p>
<p><strong>WinDeco</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами WinDeco               | WinDeco        | windeco        |  WinDeco              |</p>
<p><strong>Dooya</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами Dooya DT82            | Dooya 82       | dooya          |  Dooya 82             |
| Мотор управления шторами Akko AM82             | Dooya 82       | dooya          |  Dooya 82             |</p>
<p><strong>Dauerhaft</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами Dauerhaft             | Dauerhaft      | dauerhaft      |  Dauerhaft            |</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../wb-mqtt-homeui/" class="btn btn-neutral float-left" title="wb-mqtt-homeui"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../wb-rules/" class="btn btn-neutral float-right" title="wb-rules">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/aadegtyarev/mkdocs-test" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../wb-mqtt-homeui/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../wb-rules/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
