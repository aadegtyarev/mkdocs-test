
<!doctype html>
<html lang="ru" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://aadegtytarev.github.io/mkdocs-test/git/includes/wb-mqtt-serial/">
      
      
        <link rel="prev" href="../../../relay/wb-mr6c-v2/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>wb-mqtt-serial - Wiren Board Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#описание" class="md-skip">
          Перейти к содержанию
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Верхний колонтитул">
    <a href="../../.." title="Wiren Board Docs" class="md-header__button md-logo" aria-label="Wiren Board Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Wiren Board Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              wb-mqtt-serial
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Поиск" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Поиск">
        
        <button type="reset" class="md-search__icon md-icon" title="Очистить" aria-label="Очистить" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Инициализация поиска
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aadegtyarev/mkdocs-test" title="Перейти к репозиторию" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Навигация" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Wiren Board Docs" class="md-nav__button md-logo" aria-label="Wiren Board Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Wiren Board Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aadegtyarev/mkdocs-test" title="Перейти к репозиторию" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Контроллеры
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Контроллеры
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../plc/wb7/" class="md-nav__link">
        Wiren Board 7
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../plc/wb6/" class="md-nav__link">
        Wiren Board 6
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Реле
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Реле
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relay/wb-mr6c-v2/" class="md-nav__link">
        WB-MR6C v.2
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Софт
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Софт
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          wb-mqtt-serial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        wb-mqtt-serial
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Содержание раздела">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Содержание раздела
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#описание" class="md-nav__link">
    Описание
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#файл-конфигурации-и-шаблоны" class="md-nav__link">
    Файл конфигурации и шаблоны
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#особенности-работы-драйвера" class="md-nav__link">
    Особенности работы драйвера
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#протоколы" class="md-nav__link">
    Протоколы
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/aadegtyarev/mkdocs-test/edit/main/docs/git/includes/wb-mqtt-serial.md" title="Редактировать страницу" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


  <h1>wb-mqtt-serial</h1>

<p>Serial device &lt;==&gt; MQTT bridge which follows <a href="https://github.com/wirenboard/conventions/blob/main/README.md">Wiren Board MQTT Conventions</a>.
It's designed to be used on <a href="https://wirenboard.com/en/">Wiren Board</a> family of programmable automation controllers.</p>
<p>Драйвер master-slave протоколов для устройств, работающих через
последовательный порт. Драйвер предназначен для устройств <a href="https://wirenboard.com/ru">Wiren Board</a> и соответствует <a href="https://github.com/wirenboard/conventions/blob/main/README.md">Конвенции Wiren Board MQTT</a>.</p>
<p><strong>Содержание</strong>
- <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Описание">Описание</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Поддерживаемые-протоколы">Поддерживаемые протоколы</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Управление-драйвером">Управление драйвером</a>
- <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Файл-конфигурации-и-шаблоны">Файл конфигурации и шаблоны</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Общая-информация">Общая информация</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Шаблоны-конфигурации">Шаблоны конфигурации</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Перевод-названий-параметров-устройств">Перевод названий параметров устройств</a>
- <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Особенности-работы-драйвера">Особенности работы драйвера</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Таймауты-и-количество-неудачных-циклов">Таймауты и количество неудачных циклов</a><br />
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Замечания-для-TCP-или-MODBUS-TCP-порта">Замечания для TCP или MODBUS TCP порта</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Диаграмма-таймаутов-цикла-опроса">Диаграмма таймаутов цикла опроса</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Объединенное-чтение-регистров-и-его-авто-отключение">Объединенное чтение регистров и его авто-отключение</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Прямое-чтение-и-запись-в-порт">Прямое чтение и запись в порт</a>
- <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Протоколы">Протоколы</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Поддержка-различных-протоколов-на-одной-шине">Поддержка различных протоколов на одной шине</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Широковещательные-сообщения">Широковещательные сообщения</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Энергомера-ГОСТ-МЭК-61107">Энергомера ГОСТ МЭК 61107</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#НЕВА-МТ-32х-ГОСТ-МЭК-61107">НЕВА МТ 32х ГОСТ МЭК 61107</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#dlmscosem-и-сподэс">DLMS/COSEM и СПОДЭС</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Somfy-SDN">Somfy SDN</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#WinDeco">WinDeco</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Dooya">Dooya</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Меркурий-200">Меркурий 200</a>
  - <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/README.md#Таблица-шаблонов-device_type">Таблица шаблонов device_type</a></p>
<h2 id="описание">Описание<a class="headerlink" href="#описание" title="Permanent link">&para;</a></h2>
<h3 id="поддерживаемые-протоколы">Поддерживаемые протоколы<a class="headerlink" href="#поддерживаемые-протоколы" title="Permanent link">&para;</a></h3>
<p>Драйвер wb-mqtt-serial поддерживает устройства, работающие по протоколам:
- <a href="https://modbus.org">Modbus</a>,
- <a href="http://smart.uniel.ru">Uniel</a>,
- <a href="http://www.eksis.ru/catalog/measures-of-relative-humidity-and-temperature/">ИВТМ</a>,
- <a href="http://www.incotexcom.ru/m230art.htm">Меркурий 230</a>,
- <a href="http://www.incotexcom.ru/m200.htm">Меркурий 200</a>,
- <a href="http://www.milur.ru">Милур</a>,
- <a href="http://www.energomera.ru">Энергомера ГОСТ МЭК 61107</a>,
- <a href="https://www.meters.taipit.ru">НЕВА МТ 32х ГОСТ МЭК 61107</a>,
- <a href="https://www.dlms.com">DLMS/COSEM</a>, СПОДЭС (ГОСТ Р 58940-2020),
- <a href="https://www.somfy.com">Somfy SDN</a>,
- WinDeco,
- Dooya.</p>
<h3 id="управление-драйвером">Управление драйвером<a class="headerlink" href="#управление-драйвером" title="Permanent link">&para;</a></h3>
<p>По умолчанию драйвер установлен на всех контроллерах Wiren Board и запускается автоматически при наличии непустого конфигурационного файла <code>/etc/wb-mqtt-serial.conf</code>. При первоначальной установке пакета создаётся конфигурационный файл, в котором не описано ни одного подключенного устройства. Добавьте устройства в <code>/etc/wb-mqtt-serial.conf</code>, либо воспользуйтесь онлайн-редактором настроек для начала работы.</p>
<p>Настройка пользователем производится через веб-интерфейс контроллера, но вы можете управлять им вручную:
- <code>systemctl start wb-mqtt-serial</code> — запустить
- <code>systemctl stop wb-mqtt-serial</code> — остановить
- <code>systemctl status wb-mqtt-serial</code> — узнать состояние</p>
<p>Возможен запуск демона вручную, что может быть полезно
для работы в отладочном режиме:</p>
<div class="highlight"><pre><span></span><code># service wb-mqtt-serial stop
# wb-mqtt-serial -c /etc/wb-mqtt-serial.conf -d
</code></pre></div>
<h2 id="файл-конфигурации-и-шаблоны">Файл конфигурации и шаблоны<a class="headerlink" href="#файл-конфигурации-и-шаблоны" title="Permanent link">&para;</a></h2>
<h3 id="общая-информация">Общая информация<a class="headerlink" href="#общая-информация" title="Permanent link">&para;</a></h3>
<p>Конфигурационный файл построен по трёхуровневой схеме:
порты (ports) -&gt; устройства (devices) -&gt; каналы (channels).</p>
<p>Конфигурация устройства device может быть задана двумя способами: вручную прописать все параметры или задать только несколько параметров.</p>
<p>Пример файла конфигурации с описанием параметров:
<div class="highlight"><pre><span></span><code>{
    // По DeviceType драйвер будет искать в папках с шаблонами описаний устройств
    &quot;device_type&quot; : &quot;DeviceType&quot;,

    // отображаемое имя устройства. Публикуется как
    // .../meta/name в MQTT
    // По умолчанию name берется из шаблона и добавляется slave_id, т.е.
    // &quot;name&quot; + &quot; &quot; + &quot;slave_id&quot;
    &quot;name&quot; : &quot;somename&quot;,

    // уникальный идентификатор устройства в MQTT.
    // каждый элемент в devices должен иметь уникальный id
    // topic&#39;и, относящиеся в MQTT к данному устройству,
    // имеют общий префикс /devices/&lt;идентификатор топика&gt;/...
    // также по умолчанию берется из шаблона с добавлением slave_id:
    // &quot;deviceID&quot; + &quot;_&quot; + slave_id
    &quot;id&quot; : &quot;deviceID&quot;,

    // идентификатор slave
    &quot;slave_id&quot; : slaveID,

    // включить/выключить устройство. В случае задания
    // &quot;enabled&quot;: false опрос устройства и запись значений
    // его каналов не происходит. По умолчанию - true.
    &quot;enabled&quot; : true,

    // если используется шаблон устройства, определения
    // каналов совмещаются. Если имя (name) в определении
    // канала устройства совпадает с именем канала в шаблоне,
    // свойства каналов из шаблона и определения устройства
    // совмещаются, при этом значения свойств из определения
    // устройства (в файле конфигурации) имеют преимущество.
    // Это можно использовать, например, для задания индивидуальных
    // интервалов опроса каналов. Если канал с таким же
    // именем, как канал в определении устройства, отсутствует
    // в шаблоне, создаётся новый канал.
    &quot;channels&quot;: [
        {
            // имя канала. topic&#39;и, соответствующие каналу,
            &quot;name&quot; : &quot;Temp 1&quot;,
            &quot;read_period_ms&quot;: 10000
        }
    ]
}
</code></pre></div></p>
<p>Ниже приведён пример конфигурационного файла <code>/etc/wb-mqtt-serial.conf</code></p>
<div class="highlight"><pre><span></span><code>{
    // опция debug включает или выключает отладочную печать.
    // Опция -d командной строки wb-mqtt-serial также
    // включает отладочную печать и имеет приоритет над
    // данной опцией.
    &quot;debug&quot;: false,

    // Задаёт интервал в секундах, в течение которого неизменяющиеся значения не будут публиковаться в MQTT.
    // По истечении интервала полученное значение будет опубликовано, даже если оно не изменилось.
    // Минимальный интервал - 5 секунд.
    // Если установлено отрицательное значение, то значения будут публиковаться только при изменении. Это поведение по умолчанию.
    &quot;max_unchanged_interval&quot;: -1,

    // Задаёт максимальное число чтений регистров в секунду.
    // Не влияет на чтение регистров с заданным интервалом опроса.
    // Для снижения нагрузки на процессор рекомендуется задавать значение не более 100 для WB6 и не более 800 для WB7
    &quot;rate_limit&quot;: 100,

    // список портов
    &quot;ports&quot;: [
        {
            // тип порта:
            // - &quot;serial&quot;: последовательные порты RS-485 или RS-232. Это значение выбирается по умолчанию.
            // - &quot;tcp&quot;: serial over TCP/IP. Пакеты, формируемые для работы с последовательными портами, передаются без изменений через TCP/IP.
            // - &quot;modbus tcp&quot;: передача по MODBUS TCP. В секции устройств с таким типом порта могут использоваться только те, что поддерживают MODBUS.
            &quot;port_type&quot;: &quot;serial&quot;,

            // устройство, соответствующее порту RS-485 (если выбран тип порта serial)
            &quot;path&quot; : &quot;/dev/ttyRS485-1&quot;,

            // IP адрес или имя хоста (если выбран тип порта TCP или MODBUS TCP)
            &quot;address&quot;: &quot;127.0.0.1&quot;,

            // TCP порт (если выбран тип порта TCP или MODBUS TCP)
            &quot;port&quot;: 3000,

            // скорость порта
            &quot;baud_rate&quot;: 9600,

            // чётность - N, O или E (по умолчанию - N)
            &quot;parity&quot;: &quot;N&quot;,

            // количество бит данных (по умолчанию - 8)
            &quot;data_bits&quot;: 8,

            // количество стоп-бит
            &quot;stop_bits&quot;: 2,

            // Максимальное время ответа устройств, подключенных к этому порту, в миллисекундах
            // Если не установлено, то принимается равным 500 мс
            // Этот параметр задан в шаблонах описания устройств, переопределять его можно только в случае некорректной работы с устройствами
            &quot;response_timeout_ms&quot;: 100,

            // Дополнительная задержка перед каждой отправкой данных в порт в микросекундах
            // Если при работе с устройством теряются пакеты — попробуйте увеличить значение этого параметра.
            // Для соответствия протоколу Modbus RTU, установите этот параметр в значение не менее 3.5 символа при выбранной скорости — это не нужно для устройств Wiren Board, но может потребоваться для устройств сторонних производителей. Нужное значение рассчитывается по формуле: guard_interval_us = (3.5*11*106)/(скорость в бит/с). Например, для скорости 9600 бит/с guard_interval_us = (3.5*11*106)/9600 = 4000 мкс.
            &quot;guard_interval_us&quot;: 1000,

            // Таймаут соединения (только для TCP или MODBUS TCP порта).
            // Если в течение указанного времени ни по одному устройству на порту не поступило данных (а также истек &quot;connection_max_fail_cycles&quot;),
            // TCP соединение будет разорвано и произойдет попытка переподключения
            &quot;connection_timeout_ms&quot;: 5000,

            // Количество неудачных циклов опроса (только для TCP или MODBUS TCP порта)
            // Если в течение указанного количества циклов опроса ни по одному устройству на порту не поступило данных (а также истек &quot;connection_timeout_ms&quot;),
            // TCP соединение будет разорвано и произойдет попытка переподключения
            &quot;connection_max_fail_cycles&quot;: 2,

            // включить/выключить порт. В случае задания
            // &quot;enabled&quot;: false опрос порта и запись значений
            // каналов в устройства на данном порту не происходит.
            // По умолчанию - true.
            &quot;enabled&quot;: true,

            // список устройств на данном порту
            &quot;devices&quot; : [
                {
                    // тип устройства, в системе должен быть корректный шаблон для этого типа
                    &quot;device_type&quot;: &quot;MSU34+TLP&quot;,

                    // отображаемое имя устройства. Публикуется как
                    // .../meta/name в MQTT
                    &quot;name&quot;: &quot;MSU34+TLP&quot;,

                    // уникальный идентификатор устройства в MQTT.
                    // каждое элемент в devices должен иметь уникальный id
                    // topic&#39;и, относящиеся в MQTT к данному устройству,
                    // имеют общий префикс /devices/&lt;идентификатор топика&gt;/...
                    &quot;id&quot;: &quot;msu34tlp&quot;,

                    // идентификатор устройства. 
                    // Если не указан, то используются широковещательные запросы
                    &quot;slave_id&quot;: 2,

                    // включить/выключить устройство. В случае задания
                    // &quot;enabled&quot;: false опрос устройства и запись значений
                    // его каналов не происходит. По умолчанию - true.
                    &quot;enabled&quot;: true,

                    // протокол передачи устройства, если не задан, то используется &quot;modbus&quot;
                    &quot;protocol&quot;: &quot;modbus&quot;,

                    // максимальное количество считываемых &quot;пустых&quot; регистров.
                    // Драйвер в целях оптимизации может считывать регистры
                    // &quot;пачкой&quot;. При этом, если какие-либо регистры не
                    // были включены в конфигурацию, но в целях ускорения
                    // опроса (чтобы не разрывать &quot;пачку&quot;) их всё-таки
                    // можно считывать, можно указать значение max_reg_hole
                    // больше 0. В данный момент поддерживается только
                    // устройствами Modbus.
                    &quot;max_reg_hole&quot;: 10,

                    // то же самое, что max_reg_hole, но для однобитовых
                    // регистров (coils и discrete inputs в Modbus). В данный
                    // момент поддерживается только устройствами Modbus.
                    &quot;max_bit_hole&quot;: 80,

                    // Включить режим непрерывного чтения регистров.
                    // Поддерживается только в устройствах Wiren Board
                    &quot;enable_wb_continuous_read&quot;: true,

                    // максимальное количество регистров в одной пакетной операции
                    // чтения. В данный момент поддерживается только устройствами
                    // Modbus.
                    &quot;max_read_registers&quot;: 10,

                    // минимальное количество регистров в одной пакетной операции
                    // чтения. В данный момент поддерживается только устройствами
                    // Modbus.
                    &quot;min_read_registers&quot;: 1,

                    // Максимальное время ответа устройства в миллисекундах.
                    // Если не установлено, то принимается равным 500 мс. 
                    // Если значение этого параметра, установленное для порта, больше указанного здесь, используется значение порта.
                    // Этот параметр задан в шаблонах описания устройств, переопределять его можно только в случае некорректной работы с устройством.
                    &quot;response_timeout_ms&quot;: 100,

                    // Минимально необходимая задержка между посылками в миллисекундах.
                    // Используется в некоторых протоколах для определения границ посылок.
                    // Этот параметр задан в шаблонах описания устройств, переопределять его можно только в случае некорректной работы с устройством.
                    // По умолчанию 20 мс
                    &quot;frame_timeout_ms&quot;: 100,

                    // Дополнительная задержка перед каждой отправкой данных в порт в микросекундах.
                    // Если не установлено, то используется значение, заданное в соответствующем параметре порта.
                    &quot;guard_interval_us&quot;: 0,

                    // (При возникновении ошибки) Интервал после последнего успешного обмена данными с устройством,
                    // по истечении которого (а также &quot;device_max_fail_cycles&quot;) устройство будет помечено отключенным и будет опрашиваться в ограниченном режиме
                    &quot;device_timeout_ms&quot;: 3000,

                    // Количество неудачных циклов опроса устройства
                    // Если в течение указанного количества полных циклов опроса ни по одному регистру устройства не поступило данных (а также истек &quot;device_timeout_ms&quot;),
                    // устройство будет помечено отключенным и будет опрашиваться в ограниченном режиме
                    &quot;device_max_fail_cycles&quot;: 2,

                    // пароль для доступа к устройству, массив байт
                    &quot;password&quot;: [1, 2, 3],

                    // уровень доступа при опросе устройства,
                    // используется для обмена с счётчиками электроэнергии
                    &quot;access_level&quot;: 1,

                    // Параметр, заданный в шаблоне устройства
                    &quot;param1&quot;: 10,

                    // список каналов устройства
                    &quot;channels&quot;: [
                        {
                            // имя канала, используется в диагностических сообщениях и, 
                            // если не задан параметр id, для формирования названия MQTT topic&#39;ов канала
                            &quot;name&quot; : &quot;Temp 1&quot;,

                            // имя MQTT контрола канала. topic&#39;и, соответствующие каналу,
                            // публикуются как /devices/&lt;идентификатор устройства&gt;/controls/&lt;ID канала&gt;
                            // если не задан, то используется значение параметра name
                            &quot;id&quot; : &quot;Temp&quot;,

                            // Включает канал в цикл опроса. По умолчанию, равен true.
                            &quot;enabled&quot;: true,

                            // тип регистра
                            // возможные значения для Modbus:
                            // &quot;coil&quot; - 1 бит, чтение/запись
                            // &quot;discrete&quot; - 1 бит, только чтение
                            // &quot;holding&quot; - 16 бит, чтение/запись, код функции на запись выбирается автоматически, в зависимости от размера
                            // &quot;input&quot; - 16 бит, только чтение
                            // &quot;holding_single&quot; - то же что и holding однако регистры записываются всегда по одному, кодом 06
                            // &quot;holding_multi&quot; - то же что и holding однако регистры записываются всегда кодом 16
                            &quot;reg_type&quot; : &quot;input&quot;,

                            // адрес регистра
                            // Можно читать отдельные биты регистра, для этого запишите адрес в формате: &quot;address&quot;:&quot;reg:shift:width&quot;, где reg — адрес регистра, shift — смещение от начала, а width — количество считываемых битов. 
                            // Например, &quot;address&quot;:&quot;109:1:2&quot; — прочитать второй и третий биты регистра, расположенного по адресу 109.
                            &quot;address&quot; : 0,

                            // тип элемента управления, например,
                            // &quot;temperature&quot;, &quot;text&quot;, &quot;switch&quot;

                            &quot;type&quot;: &quot;temperature&quot;,

                            // формат канала. Задаётся для регистров типа
                            // &quot;holding&quot; и &quot;input&quot;. Возможные значения:
                            // &quot;u16&quot; - беззнаковое 16-битное целое
                            //         (используется по умолчанию)
                            // &quot;s16&quot; - знаковое 16-битное целое
                            // &quot;u8&quot; - беззнаковое 8-битное целое
                            // &quot;s8&quot; - знаковое 8-битное целое
                            // &quot;u32&quot; - беззнаковое 32-битное целое (big-endian).
                            //     (занимает 2 регистра, начиная с указанного)
                            // &quot;s32&quot; - знаковое 32-битное целое (big-endian).
                            //     (занимает 2 регистра, начиная с указанного)
                            // &quot;s64&quot; - знаковое 64-битное целое (big-endian).
                            //     (занимает 4 регистра, начиная с указанного)
                            // &quot;u64&quot; - беззнаковое 64-битное целое (big-endian).
                            //     (занимает 4 регистра, начиная с указанного)
                            //
                            // &quot;float&quot; - число с плавающей точкой IEEE 754. 32 bit. (big-endian).
                            //     (занимает 2 регистра, начиная с указанного)
                            // &quot;double&quot; - число с плавающей точкой двойной точности IEEE 754. 64 bit. (big-endian).
                            //     (занимает 4 регистра, начиная с указанного)
                            // &quot;char8&quot; - однобайтовый символ в кодировке ASCII
                            // &quot;string&quot; - строка с настраиваемым количеством символов.
                            //            Для протокола modbus строки считываются по одному символу на регистр из младшего байта. 

                            &quot;format&quot;: &quot;s8&quot;,

                            // Порядок 16-битных слов для каналов, имеющих размер больше 16 бит.
                            // Возможные значения:
                            //  &quot;big_endian&quot; (по-умолчанию): [0xAA 0xBB] [0xCC 0xDD] =&gt; 0xAABBCCDD
                            //  &quot;little_endian&quot;:  [0xAA 0xBB] [0xCC 0xDD] =&gt; 0xCCDDAABB
                            &quot;word_order&quot; : &quot;big_endian&quot;,

                            // Период чтения данного канала в миллисекундах
                            // Рекомендуется использовать для каналов, данные от которых надо получать с минимальными задержками
                            // Чтение каналов с заданным периодом имеет больший приоритет, чем чтение других каналов
                            // Если не указан, чтение будет производиться в свободное от опроса других каналов время
                            &quot;read_period_ms&quot;: 10,

                            // Интервал в миллисекундах, который должен пройти между двумя последовательными чтениями канала.
                            // Учитывается, если не задан параметр &quot;read_period_ms&quot;.
                            // Не рекомендуется к использованию, поддерживается для обратной совместимости с ранее созданными конфигурационными файлами.
                            // Вместо него рекомендуется использовать read_period_ms.
                            &quot;read_rate_limit_ms&quot;: 10000,

                            // значение, получаемое при последовательном чтении диапазона регистров, если устройство не поддерживает запрашиваемый регистр.
                            // Этот параметр используется некоторыми протоколами, чтобы определить доступность регистров устройства.
                            &quot;unsupported_value&quot;: &quot;0xFFFE&quot;,

                            // максимальное значение регистра, используется для построения интерфейса веб-конфигуратора
                            &quot;max&quot;: 100,

                            // коэффициент, на который умножается значение регистра перед публикацией в MQTT
                            &quot;scale&quot;: 0.5,

                            // значение, которое прибавляется к значению регистра перед публикацией в MQTT
                            &quot;offset&quot;: -12.5,

                            // порядок, до которого будет округляться значение после всех преобразований
                            &quot;round_to&quot;: 0.1,

                            // использовать события расширенного modbus, вместо опроса
                            // (если поддерживается прошивкой устройства)
                            &quot;sporadic&quot;: false,

                            // доступен ли канал для записи через MQTT
                            &quot;readonly&quot;: true,

                            // значение, которое будет записано в регистр, при записи единицы в on-топик в MQTT
                            &quot;on_value&quot;: &quot;0xFF&quot;,

                            // значение, которое будет записано в регистр, при записи нуля в on-топик в MQTT
                            &quot;off_value&quot;: &quot;0xAA&quot;,

                            // значение регистра, полученное от устройства, которое обозначает ошибку
                            &quot;error_value&quot;: &quot;0xAA&quot;,

                            // Длина строки в символах. Необходимая опция, если выбран формат &quot;string&quot;
                            &quot;string_data_size&quot;: 5
                        },
                        {
                            // Ещё один канал
                            &quot;name&quot; : &quot;Illuminance&quot;,
                            &quot;reg_type&quot; : &quot;input&quot;,
                            &quot;address&quot; : 1,
                            &quot;type&quot;: &quot;text&quot;
                        },
                        {
                            &quot;name&quot; : &quot;Pressure&quot;,
                            &quot;reg_type&quot; : &quot;input&quot;,
                            &quot;address&quot; : 2,
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;scale&quot;: 0.075
                        },
                        {
                            &quot;name&quot; : &quot;Temp 2&quot;,
                            &quot;reg_type&quot; : &quot;input&quot;,
                            &quot;address&quot; : 3,
                            &quot;type&quot;: &quot;temperature&quot;,
                            &quot;format&quot;: &quot;s8&quot;
                        }
                    ]
                },
                {
                    // ещё одно устройство на канале
                    &quot;name&quot;: &quot;DRB88&quot;,
                    &quot;id&quot;: &quot;drb88&quot;,
                    &quot;enabled&quot;: true,
                    &quot;slave_id&quot;: 22,

                    // секция инициализации
                    &quot;setup&quot;: [
                        {
                            // название регистра
                            // Выводится в случае включённой отладочной печати.
                            &quot;title&quot;: &quot;Input 0 type&quot;,

                            // адрес регистра
                            &quot;address&quot;: 1,

                            // значение для записи
                            &quot;value&quot;: 1,

                            // тип регистра, если не указан, то для Modbus используется &quot;holding&quot;
                            &quot;reg_type&quot; : &quot;input&quot;,

                            // формат регистра, для Modbus по умолчанию u16
                            &quot;format&quot;: &quot;s8&quot;
                        },
                        {
                            &quot;title&quot;: &quot;Input 0 module&quot;,
                            &quot;address&quot;: 3,
                            &quot;value&quot;: 3
                        }
                    ],
                    &quot;channels&quot;: [
                        {
                            &quot;name&quot; : &quot;Relay 1&quot;,
                            &quot;reg_type&quot; : &quot;coil&quot;,
                            &quot;address&quot; : 0,
                            &quot;type&quot;: &quot;switch&quot;
                        },
                        {
                            &quot;name&quot; : &quot;Relay 2&quot;,
                            &quot;reg_type&quot; : &quot;coil&quot;,
                            &quot;address&quot; : 1,
                            &quot;type&quot;: &quot;switch&quot;
                        },
                        // ...
                        {
                            &quot;name&quot; : &quot;Input 2&quot;,
                            &quot;reg_type&quot; : &quot;input&quot;,
                            &quot;address&quot; : 1,
                            &quot;type&quot;: &quot;switch&quot;,
                            &quot;on_value&quot;: 101
                        },
                        {
                            &quot;name&quot; : &quot;Input 3&quot;,
                            &quot;reg_type&quot; : &quot;input&quot;,
                            &quot;address&quot; : 2,
                            &quot;type&quot;: &quot;switch&quot;,
                            &quot;on_value&quot;: 101
                        },
                        // ...
                    ]
                }
            ]
        },
        {
            // ещё один порт со своим набором устройств
            &quot;path&quot; : &quot;/dev/ttyNSC1&quot;,
            &quot;baud_rate&quot;: 9600,
            &quot;parity&quot;: &quot;N&quot;,
            &quot;data_bits&quot;: 8,
            &quot;stop_bits&quot;: 1,
            &quot;enabled&quot;: true,
            &quot;devices&quot; : [
                {
                    &quot;name&quot;: &quot;tM-P3R3&quot;,
                    &quot;id&quot;: &quot;tmp3r3&quot;,
                    &quot;enabled&quot;: true,
                    &quot;slave_id&quot;: 1,
                    &quot;channels&quot;: [
                        {
                            &quot;name&quot; : &quot;Relay 0&quot;,
                            &quot;reg_type&quot; : &quot;coil&quot;,
                            &quot;address&quot; : 0,
                            &quot;type&quot;: &quot;switch&quot;
                        },
                        // ...
                    ]
                },
                // ...
            ]
        }
    ]
}
</code></pre></div>
<h3 id="шаблоны-конфигурации">Шаблоны конфигурации<a class="headerlink" href="#шаблоны-конфигурации" title="Permanent link">&para;</a></h3>
<p>Шаблоны создаются для удобства конфигурации Modbus-устройств.</p>
<p>Шаблон конфигурации представляет собой .json файл, который содержит информацию о регистрах и параметрах устройства. </p>
<p>Для примера в <a href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/config.sample.json">файле</a> приведены разные варианты записи параметров:
- первое устройство задано через шаблон;
- второе устройство тоже через шаблон, но параметры "name" и "id" заданы, и можно добавить конфигурацию для канала, который добавится к тем, что есть в шаблоне;
- параметры третьего устройства записаны явно;
- для четвёртого задано значение одного из параметров. Параметр описан в шаблоне.</p>
<p>В состав пакета изначально входят шаблоны конфигурации некоторых поддерживаемых устройств. Они хранятся на контроллере в папке <code>/usr/share/wb-mqtt-serial/templates</code>. Для хранения пользовательских шаблонов используется папка <code>/etc/wb-mqtt-serial.conf.d/templates</code>. </p>
<p>Для создания собственного шаблона можно скопировать существующий из папки <code>/usr/share/wb-mqtt-serial/templates</code>, изменить в нем нужные параметры, добавить необходимые регистры устройства и сохранить его в папку <code>/etc/wb-mqtt-serial.conf.d/templates</code> с новым именем. </p>
<p>При необходимости внести обратно несовместимые изменения в шаблон, его необходимо отметить устаревшим (добавить <code>"deprecated": true</code>) и создать его копию (при этом в <code>device_type</code>  нового шаблона добавить префикс с версией <code>tpl1_</code>, <code>tpl2_</code> и т.д.).</p>
<p>После добавления шаблона конфигурации вы можете выбрать новое устройство из выпадающего списка в настройках serial устройств в веб-интерфейсе контроллера Wiren Board.</p>
<p>Пример шаблона:
<div class="highlight"><pre><span></span><code>{
    // Название типа устройства, оно указывается в поле device_type в файле настроек
    &quot;device_type&quot;: &quot;Device type name&quot;,

    // Группа устройств в выпадающем списке в настройках последовательного порта в веб-интерфейсе контроллера
    // Если не задано устройство будет отображаться внизу списка 
    // Возможные варианты:
    // g-wb — устройства Wiren Board
    // g-wb-old — устаревшие устройства Wiren Board
    // g-adapter — адаптеры протоколов
    // g-climate-sensor — датчики климата
    // g-level — датчики уровня
    // g-dimmer — диммеры
    // g-air-conditioning — кондиционеры
    // g-climate-control — контроллеры вентиляции и климата
    // g-refrigeration — контроллеры холодильного оборудования
    // g-io — модули ввода-вывода
    // g-relay — модули реле
    // g-curtain — моторы для штор / электрокарнизы
    // g-control-panel — панели управления
    // g-water-meter — счетчики воды
    // g-heat-meter — счетчики тепла
    // g-power-meter — счетчики электроэнергии
    // g-thermostat — термостаты
    // g-motor-control — управление двигателями (преобразователи частоты)
    // g-custom — произвольные устройства

    &quot;group&quot;: &quot;g-wb&quot;,

    // Название типа устройства, которое будет отображаться в веб-конфигураторе.
    // Необязательный параметр. Если не указан, используется device_type.
    &quot;title&quot;: &quot;Device&quot;,

    // Признак того, что шаблон устарел, он не будет доступен для выбора при добавлении устройства в веб-конфигураторе
    // Также для такого шаблона будут игнорироваться возможные ошибки валидации на соответствие JSON схеме
    &quot;deprecated&quot;: true,

    &quot;device&quot;: {
        // отображаемое имя устройства. Публикуется как
        // .../meta/name в MQTT
        &quot;name&quot;: &quot;New device&quot;,

        // Остальные параметры устройства, описанные выше в примере конфигурационного файла, кроме slave_id
        ...

        // Шаблон может иметь собственную секцию с настройками
        &quot;setup&quot;: [
            {
                &quot;title&quot;: &quot;s1&quot;,
                &quot;address&quot;: 20000,
                &quot;value&quot;: &quot;0xfff2&quot;
            },
            ...
        ],

        // Секция с описанием параметров устройства.
        // Значение параметра можно задать в файле конфигурации или через веб-конфигуратор
        &quot;parameters&quot;: [
            {
                // Имя параметра, которе будет использовано в конфигурационном файле
                &quot;id&quot;: &quot;param1&quot;,

                // Название параметра в веб-конфигураторе
                &quot;title&quot;: &quot;s22&quot;,

                // Адрес регистра параметра
                &quot;address&quot;: 9992,

                // Адрес регистра параметра только для записи (задается при необходимости).
                // Если задан, то чтение параметра производится по адресу, указанному в &quot;address&quot;,
                // а запись — по адресу, указанному в &quot;write_address&quot;.
                // При этом, если параметр &quot;address&quot; не указывать, то будет доступна только запись по адресу в &quot;write_address&quot;.
                &quot;write_address&quot;: 9995

                // Тип регистра
                &quot;reg_type&quot; : &quot;input&quot;,

                // Формат регистра
                &quot;format&quot;: &quot;s8&quot;,

                // Список возможных значений
                &quot;enum&quot;: [1, 2, 3],

                // Надписи в списке выбора в веб-конфигураторе
                &quot;enum_titles&quot;: [&quot;one&quot;, &quot;two&quot;, &quot;three&quot; ],

                // Значение по умолчанию в веб-конфигураторе
                &quot;default&quot;: 2,

                // Минимально возможное значение
                &quot;min&quot;: 1,

                // Максимально возможное значение
                &quot;max&quot;: 3,

                // Коэффициент, на который делится значение параметра перед записью в регистр
                &quot;scale&quot;: 2,

                // Значение, которое прибавляется к значению параметра перед записью в регистр
                &quot;offset&quot;: 10,

                // Этот параметр должен быть обязательно задан в wb-mqtt-serial.conf
                &quot;required&quot;: true,

                // Порядок отображения параметра в веб-конфигураторе
                &quot;order&quot;: 1,

                // Группа, к которой относится параметр
                &quot;group&quot;: &quot;group1&quot;,

                // Условие, при выполнении которого, значение параметра будет записано в устройство
                // В состав условия могут входить целые числа, названия других параметров, 
                // операции сравнения (&gt;, &lt;, &gt;=, &lt;=, ==, !=), логические операции (&amp;&amp;, ||) и функция isDefined.
                // При вычислении условия вместо имён параметров подставляются их значения из конфигурационного файла.
                // Если какой-то параметр из условия не задан в конфигурационном файле, 
                // то операции сравнения (&gt;, &lt;, &gt;=, &lt;=, ==) с ним возвращают false, операция проверки неравенства (!=) - возвращает true.
                // Функция isDefined позволяет определить задан ли параметр в конфигурационном файле
                // Условие также определяет доступность параметра для редактирования в интерфейсе веб-конфигуратора
                &quot;condition&quot;: &quot;isDefined(param1)&amp;&amp;(param2==1)||(param3&gt;5)&quot;,

                // Признак того, что значение параметра не записывается в регистры устройства.
                // Может быть использовано для организации настроек в веб-конфигураторе.
                // В зависимости от значения будут отображены только нужные каналы и параметры.
                // В дальнейшем значения таких параметров будет читаться из устройств.
                &quot;readonly&quot;: true
            }
        ],

        // Список каналов
        &quot;channels&quot;: [
            // Пример канала, описывающий данные одного регистра
            {
                &quot;name&quot;: &quot;Temperature&quot;,
                &quot;reg_type&quot;: &quot;input&quot;,
                &quot;format&quot;: &quot;s32&quot;,
                &quot;address&quot;: &quot;0x0504&quot;,
                &quot;group&quot;: &quot;group1&quot;,

                // Условие, при выполнении которого, канал будет доступен для опроса
                &quot;condition&quot;: &quot;(param2==1)||(param3==5)&quot;
            },
            ...
        ],

        // Группы используются для удобной организации интерфейса веб-конфигуратора
        // и не влияют на структуру конфигурационного файл
        &quot;groups&quot;: [
            // Описание группы
            {
                // Уникальное имя группы, отображается в веб-конфигураторе
                &quot;title&quot;: &quot;Group 1&quot;,

                // Идентификатор группы
                &quot;id&quot;: &quot;group1&quot;,

                // Позиция группы в списке каналов
                // Если не задана, группа будет расположена перед остальными каналами
                &quot;order&quot;: 3,

                // Группа вложена в другую группу
                &quot;group&quot;: &quot;group2&quot;,

                // Описание группы
                &quot;description&quot;: &quot;Group description&quot;
            },
            ...
        ]
    }
}
</code></pre></div></p>
<h3 id="перевод-названий-параметров-устройств">Перевод названий параметров устройств<a class="headerlink" href="#перевод-названий-параметров-устройств" title="Permanent link">&para;</a></h3>
<p>Переводы используются в веб-конфигураторе для формирования интерфейса настройки устройств. Они описываются в шаблоне устройства в секции <code>translations</code>. Эта секция содержит переводы строк, которые могут встречаться в названиях параметров, отчетах об ошибках и т.д. Секция содержит набор параметров <code>"Язык": "Строка на английском": "Перевод"</code>.
Например:
<div class="highlight"><pre><span></span><code>{
    &quot;device_type&quot;: &quot;Example&quot;,
    &quot;title&quot;: &quot;Device&quot;,
    &quot;device&quot;: {
        &quot;name&quot;: &quot;Example device&quot;,
        &quot;channels&quot;: [
            {
                &quot;name&quot;: &quot;Temperature&quot;,
                &quot;reg_type&quot;: &quot;holding&quot;,
                &quot;address&quot;: 1,
                &quot;group&quot;: &quot;group 1&quot;
            }
        ],
        &quot;parameters&quot;: [
            {
                &quot;id&quot;: &quot;timeout&quot;,
                &quot;title&quot;: &quot;Timeout&quot;,
                &quot;address&quot;: 9992,
                &quot;group&quot;: &quot;group 1&quot;
            }
        ],
        &quot;groups&quot;: [
            {
                &quot;title&quot;: &quot;Group 1&quot;,
                &quot;id&quot;: &quot;group1&quot;,
                &quot;order&quot;: 3
            }
        ],
        &quot;translations&quot;: {
            &quot;ru&quot;: {
                &quot;Device&quot;: &quot;Устройство&quot;,
                &quot;Temperature&quot;: &quot;Температура&quot;,
                &quot;Timeout&quot;: &quot;Задержка&quot;,
                &quot;Group 1&quot;: &quot;Группа 1&quot;
            }
        }
    }
}
</code></pre></div></p>
<h2 id="особенности-работы-драйвера">Особенности работы драйвера<a class="headerlink" href="#особенности-работы-драйвера" title="Permanent link">&para;</a></h2>
<h3 id="таймауты-и-количество-неудачных-циклов">Таймауты и количество неудачных циклов<a class="headerlink" href="#таймауты-и-количество-неудачных-циклов" title="Permanent link">&para;</a></h3>
<p>Циклом опроса устройства считается внутренний цикл опроса драйвера внутри которого был опрошен хотя бы один из регистров данного устройства.</p>
<p><code>connection_timeout_ms</code> и <code>connection_max_fail_cycles</code> - указываются для порта типа TCP или MODBUS TCP. Необходимы для автоматического восстановления соединения. Если в течение <code>connection_timeout_ms</code> и более чем <code>connection_max_fail_cycles</code> подряд циклов опроса все устройства были отключены, соединение сбрасывается и происходит попытка переподключения. Можно использовать только один тип таймаута, для этого нужно выставить значение 0 другому типу таймаута (например, чтобы осуществлять обнаружение разрыва соединения только по времени, нужно выставить "<code>connection_max_fail_cycles</code>": 0). При большом количестве устройств на порту, длительность цикла опроса устройств может сильно варьироваться в зависимости от числа отвечающих устройств, т.к. они вносят дополнительные задержки на ожидание ответа, поэтому если нужно обозначить минимальное количество циклов опроса до отключения вне зависимости от числа устройств, можно использовать вариант <code>connection_max_fail_cycles</code>. При использовании только <code>connection_timeout_ms</code>, на количество попыток обращения к порту будут влиять другие временные настройки, такие как <code>poll_interval</code>, <code>guard_interval</code>, <code>response_timeout</code> и при их изменении возможно придется подстраивать значение connection_timeout_ms. Если же нужно исключить срабатывание таймаута на каких-то кратковременных случайных ошибках, которые не стоит считать обрывом связи, то нужно использовать <code>connection_timeout_ms</code>. При использовании параметров вместе, таймаут сработает только когда выполнятся оба условия, т.е. пройдет нужное время и количество циклов.</p>
<p><code>device_timeout_ms</code> и <code>device_max_fail_cycles</code> - указываются для устройства. По семантике аналогичен <code>connection_timeout_ms</code> и <code>connection_max_fail_cycles</code>, но только для устройства. Нужен для выявления отключения устройства для повторной отправки setup - секции при переподключении. Если в течение <code>device_timeout_ms</code> и более чем <code>device_max_fail_cycles</code> подряд циклов ни один из опрошенных регистров не был успешно прочитан, то устройство будет помечено как отсоединенное и будет опрашиваться в ограниченном режиме, т.е. при наличии у устройства setup - секции, драйвер будет пытаться записать ее, а в противном случае, будет пытаться опросить устройство. Если первое обращение к устройству в ограниченном режиме закончилось ошибкой, драйвер считает что устройство все еще отключено и больше не опрашивает его в этом цикле. Это позволяет тратить меньше времени на отключенные устройства. Первый успешный запрос к устройству будет расценен как переподключение устройства.</p>
<h4 id="значения-по-умолчанию">Значения по умолчанию<a class="headerlink" href="#значения-по-умолчанию" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th align="left">Параметр</th>
<th align="right">Значение</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">device_timeout_ms</td>
<td align="right">3000</td>
</tr>
<tr>
<td align="left">device_max_fail_cycles</td>
<td align="right">2</td>
</tr>
<tr>
<td align="left">connection_timeout_ms</td>
<td align="right">5000</td>
</tr>
<tr>
<td align="left">connection_max_fail_cycles</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
<h4 id="замечания-для-tcp-или-modbus-tcp-порта">Замечания для TCP или MODBUS TCP порта<a class="headerlink" href="#замечания-для-tcp-или-modbus-tcp-порта" title="Permanent link">&para;</a></h4>
<p>При использовании TCP мостов, драйвер не видит разницы между двумя ситуациями:</p>
<ul>
<li>физически отключены все устройства от моста</li>
<li>разорвано TCP соединение с мостом</li>
</ul>
<p>так как в обоих случаях никаких данных драйвер не получает. Поэтому, в этом случае, connection_timeout для порта и device_timeout для устройств истекают одновременно.</p>
<p>Это влечет за собой периодический сброс TCP соединения и переподключение к мосту в ситуации когда физически отключены все устройства от моста, хотя с самим TCP соединением проблем нет.</p>
<p>В ситуации когда хотя бы одно из опрашиваемых устройств подключено к мосту без проблем с TCP соединением, TCP подключение не будет сбрасываться, а таймаут будет отсчитываться только для отключенных устройств.</p>
<h3 id="диаграмма-таймаутов-цикла-опроса">Диаграмма таймаутов цикла опроса<a class="headerlink" href="#диаграмма-таймаутов-цикла-опроса" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/doc/timeouts.svg" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Диаграмма таймаутов цикла опроса" src="https://raw.githubusercontent.com/wirenboard/wb-mqtt-serial/master/doc/timeouts.svg" /></a></p>
<h3 id="объединенное-чтение-регистров-и-его-авто-отключение">Объединенное чтение регистров и его авто-отключение<a class="headerlink" href="#объединенное-чтение-регистров-и-его-авто-отключение" title="Permanent link">&para;</a></h3>
<p>Для ускорения опроса регистров устройств, драйвер объединяет чтение соседних регистров в один запрос (см. <code>max_reg_hole</code>, <code>max_bit_hole</code>), однако, считывание т.н. "пустых" регистров может привести к ошибкам на некоторых устройствах. Как только драйвер получает от устройства ошибку при считывании множества регистров, среди которых есть пустые, которая могла быть вызвана чтением пустых регистров (для Modbus: ILLEGAL_DATA_ADDRESS, ILLEGAL_DATA_VALUE), драйвер перестает объединённо считывать эти регистры.
Устройства Wiren Board поддерживают <a href="https://wirenboard.com/wiki/Modbus#%D0%A0%D0%B5%D0%B6%D0%B8%D0%BC_%D1%81%D0%BF%D0%BB%D0%BE%D1%88%D0%BD%D0%BE%D0%B3%D0%BE_%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D1%8F_%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%BE%D0%B2">режим сплошного чтения регистров</a>. Для его активации надо установить параметр <code>enable_wb_continuous_read</code> в шаблоне или настройках устройства.</p>
<h3 id="список-сконфигурированных-портов">Список сконфигурированных портов<a class="headerlink" href="#список-сконфигурированных-портов" title="Permanent link">&para;</a></h3>
<p>Список портов можно получить, выполнив MQTT RPC запрос <code>wb-mqtt-serial/ports/Load</code>. Он возвращает JSON массив следующего вида:
<div class="highlight"><pre><span></span><code>[
   {
       &quot;baud_rate&quot;: 9600,
       &quot;data_bits&quot;: 8,
       &quot;parity&quot;: &quot;N&quot;,
       &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;,
       &quot;stop_bits&quot;: 1
   },
   {
       &quot;address&quot;: &quot;127.0.0.1&quot;,
       &quot;port&quot;: 2000
   },
   ...
]
</code></pre></div></p>
<h3 id="прямое-чтение-и-запись-в-порт">Прямое чтение и запись в порт<a class="headerlink" href="#прямое-чтение-и-запись-в-порт" title="Permanent link">&para;</a></h3>
<p>Существует возможность выполнить запись и чтение из порта посредством MQTT RPC запроса. Выполнение запроса встраивается в цикл опроса устройств таким образом, что запрос выполнится с высоким приоритетом сразу после окончания текущего цикла опроса. 
Для упрощенного использования данного функционала написана <a href="https://github.com/wirenboard/python-mqtt-rpc/">Python-библиотека</a>. Также по <a href="https://github.com/wirenboard/modbus-utils-rpc">ссылке</a> доступна утилита для работы с modbus-устройствами при помощи RPC-функционала wb-mqtt-serial.
Для выполнения запроса необходимо отправить в топик <code>wb-mqtt-serial/port/Load/client_id</code>, где client_id - произвольное имя клиента, посылающего запрос, сообщение типа JSON со следующими параметрами:</p>
<h4 id="параметры">Параметры<a class="headerlink" href="#параметры" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Тип</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>msg</code></td>
<td>обязательный</td>
<td></td>
<td>текстовое сообщение для отправки в порт</td>
</tr>
<tr>
<td><code>response_size</code></td>
<td>обязательный</td>
<td></td>
<td>количество байт, которое нужно прочитать из порта</td>
</tr>
<tr>
<td><code>format</code></td>
<td>опциональный</td>
<td><code>STR</code></td>
<td>при указании значения <code>STR</code> содержимое параметра <code>msg</code> интерпретируется как строка и передается в порт как есть. При указании значения <code>HEX</code> содержимое <code>msg</code> интерпретируется как шестнадцатеричная строка и перед отправкой в порт преобразуется в массив байт</td>
</tr>
<tr>
<td><code>response_timeout</code></td>
<td>опциональный</td>
<td>500 ms</td>
<td>таймаут чтения первого байта в миллисекундах</td>
</tr>
<tr>
<td><code>frame_timeout</code></td>
<td>опциональный</td>
<td>20 ms</td>
<td>таймаут чтения каждого последующего байта в миллисекундах</td>
</tr>
<tr>
<td><code>total_timeout</code></td>
<td>опциональный</td>
<td>10000ms</td>
<td>таймаут выполнения RPC-запроса в миллисекундах</td>
</tr>
</tbody>
</table>
<h5 id="обязательные-параметры-запроса-в-последовательный-порт">Обязательные параметры запроса в последовательный порт<a class="headerlink" href="#обязательные-параметры-запроса-в-последовательный-порт" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>path</code></td>
<td>путь к последовательному порту, в который будет отправлено сообщение</td>
</tr>
<tr>
<td><code>baud_rate</code></td>
<td>скорость порта</td>
</tr>
<tr>
<td><code>parity</code></td>
<td>чётность - N, O или E</td>
</tr>
<tr>
<td><code>data_bits</code></td>
<td>количество бит данных</td>
</tr>
<tr>
<td><code>stop_bits</code></td>
<td>количество стоп-бит</td>
</tr>
</tbody>
</table>
<h5 id="обязательные-параметры-запроса-в-tcp-порт">Обязательные параметры запроса в TCP порт<a class="headerlink" href="#обязательные-параметры-запроса-в-tcp-порт" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ip</code></td>
<td>IP-адрес клиента, которому будет отправлено сообщение</td>
</tr>
<tr>
<td><code>port</code></td>
<td>номер порта на указанном адресе клиента</td>
</tr>
</tbody>
</table>
<p>В качестве ответа в топике <code>wb-mqtt-serial/port/Load/client_id/reply</code> будет опубликовано сообщение типа JSON со следующими параметрами:</p>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>result</code></td>
<td>В случае неуспешного выполнения запроса содержит <code>null</code>. В случае успешного выполнения содержит в себе единственное поле <code>response</code>. В случае, если при запросе в поле <code>format</code> было указано <code>STR</code>, значение поля представляет собой набор символов, полученных из порта, и передается запрашивающей стороне как есть. В случае значения <code>HEX</code> содержимое поля представляет собой шестнадцатеричную строку</td>
</tr>
<tr>
<td><code>id</code></td>
<td>Порядковый номер запроса</td>
</tr>
<tr>
<td><code>error</code></td>
<td>В случае успешного выполнения запроса содержит значение <code>null</code>. В ином случае содержит параметры, приведенные в таблице ниже</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>message</code></td>
<td>Строка с кратким описанием ошибки</td>
</tr>
<tr>
<td><code>code</code></td>
<td>Код ошибки. Возможные коды ошибок приведены в таблице ниже</td>
</tr>
<tr>
<td><code>data</code></td>
<td>Строка с подробным описанием места и условий возникновения ошибки</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Код ошибки</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-32700</code></td>
<td>Ошибка разбора JSON запроса</td>
</tr>
<tr>
<td><code>-32000</code></td>
<td>Ошибка выполнения запроса</td>
</tr>
<tr>
<td><code>-32600</code></td>
<td>Таймаут выполнения запроса</td>
</tr>
</tbody>
</table>
<p>Примеры выполнения запросов:
1. Успешное выполнение запроса:
    <div class="highlight"><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;total_timeout&quot;: 10000, &quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;}, &quot;id&quot; : 1}
RPC Client &lt;- {&quot;error&quot;:null,&quot;id&quot;:1,&quot;result&quot;:{&quot;response&quot;:&quot;1605000aff00af1f&quot;}}
</code></pre></div></p>
<ol>
<li>
<p>Ошибка разбора JSON запроса
    <div class="highlight"><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;&quot;path&quot;: &quot;/dev/ttyRS485-34534&quot;, &quot;response_size&quot;: 8, &quot;total_timeout&quot;: 10000, &quot;msg&quot;: &quot;1605000aff00af1f&quot;, &quot;format&quot;: &quot;HEX&quot;}, &quot;id&quot;: 1}
RPC Client &lt;-{&quot;error&quot;:{&quot;code&quot;:-32700,&quot;message&quot;:&quot;Parse error&quot;},&quot;id&quot;:null}
</code></pre></div></p>
</li>
<li>
<p>Ошибка выполнения запроса (ошибка ввода-вывода)
    <div class="highlight"><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;total_timeout&quot;: 10000, &quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;}, &quot;id&quot; : 1}
RPC Client &lt;- {&quot;error&quot;:{&quot;code&quot;:-32000,&quot;data&quot;:&quot;Port IO error: request timed out&quot;,&quot;message&quot;:&quot;Server error&quot;},&quot;id&quot;:1,&quot;result&quot;:null}
</code></pre></div></p>
</li>
<li>
<p>Ошибка выполнения запроса (запрос в несуществующий порт)
    <div class="highlight"><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;total_timeout&quot;: 10000, &quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-31337&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;}, &quot;id&quot; : 1}
RPC Client -&gt; {&quot;error&quot;:{&quot;code&quot;:-32000,&quot;data&quot;:&quot;Requested port doesn&#39;t exist&quot;,&quot;message&quot;:&quot;Server error&quot;},&quot;id&quot;:1,&quot;result&quot;:null}
</code></pre></div></p>
</li>
<li>
<p>Таймаут выполнения запроса (слишком малое значение таймаута)
    <div class="highlight"><pre><span></span><code>RPC Client -&gt; {&quot;params&quot;: {&quot;response_size&quot;: 8, &quot;format&quot;: &quot;HEX&quot;, &quot;path&quot;: &quot;/dev/ttyRS485-2&quot;, &quot;baud_rate&quot;: 9600, &quot;parity&quot; : &quot;N&quot;, &quot;data_bits&quot; : 8, &quot;stop_bits&quot; : 2, &quot;msg&quot;: &quot;0A03008000018499&quot;, &quot;total_timeout&quot;: 10}, &quot;id&quot; : 1}
RPC Client &lt;- {&quot;error&quot;:{&quot;code&quot;:-32600,&quot;data&quot;:&quot;Request handler is not responding @ src/rpc_handler.cpp:179&quot;,&quot;message&quot;:&quot;Request timeout&quot;},&quot;id&quot;:1,&quot;result&quot;:null}
</code></pre></div></p>
</li>
</ol>
<h2 id="протоколы">Протоколы<a class="headerlink" href="#протоколы" title="Permanent link">&para;</a></h2>
<h3 id="поддержка-различных-протоколов-на-одной-шине">Поддержка различных протоколов на одной шине<a class="headerlink" href="#поддержка-различных-протоколов-на-одной-шине" title="Permanent link">&para;</a></h3>
<p>Возможно использование устройств, работающих по различным протоколам, на одном порту. При этом следует учитывать особенности конкретных протоколов.  </p>
<p>Например, фреймы устройств Uniel начинаются с байта 0xff, устройств ИВТМ - с байта 0x24 ('$'), в случае же протоколов Modbus, Меркурий 230 и Милур первым байтом фрейма является идентификатор slave, поэтому при совмещении подобных устройств следует внимательно подходить к выбору slave id - у устройств Милур, например, slave id по умолчанию равен 0xff, что приводит к конфликту с устройствами Uniel. </p>
<p>Устройства Милур требуют дополнительных задержек при опросе (заданы в шаблоне) и при использовании на одной шине с другими устройствами могут снизить скорость опроса. </p>
<p>Некоторые устройства, поддерживающие дополнительные протоколы, могут оказаться несовместимыми с теми или иными протоколами на той же шине, например, было замечено, что устройства с поддержкой протокола A-BUS производства "Разумный дом" не могут работать на одной шине с устройствами Uniel. </p>
<p>Работа устройств ИВТМ на одной шине с устройствами, работающими по другим протоколам, не проверялась. Проверенная рабочая комбинация: Modbus + Milur (slave_id != 0xff) + Uniel на одной шине.</p>
<h3 id="modbus">Modbus<a class="headerlink" href="#modbus" title="Permanent link">&para;</a></h3>
<h3 id="широковещательные-сообщения">Широковещательные сообщения<a class="headerlink" href="#широковещательные-сообщения" title="Permanent link">&para;</a></h3>
<p>Протоколы <code>Меркурий 230</code>, <code>Энергомера ГОСТ МЭК 61107</code>,
<code>НЕВА МТ 32х ГОСТ МЭК 61107</code> поддерживают отправку широковещательных сообщений, если не указывать идентификатор устройства, или указать вместо него пустую строку. Это можно использовать, если на шине только одно устройство такого типа, и его адрес неизвестен. При этом нельзя на одном порту одновременно использовать широковещательные сообщения <code>Энергомера ГОСТ МЭК 61107</code> и <code>НЕВА МТ 32х ГОСТ МЭК 61107</code>.</p>
<h3 id="энергомера-гост-мэк-61107">Энергомера ГОСТ МЭК 61107<a class="headerlink" href="#энергомера-гост-мэк-61107" title="Permanent link">&para;</a></h3>
<p>При любых настройках порта фактический обмен с счётчиками происходит в режиме 9600 7E1, в соответствии с МЭК 61107. </p>
<p>Реализованы 2 режима обмена:
- "быстрого группового чтения" без открытия сессии (<code>"device_type": "energomera_iec"</code>);
- ГОСТ МЭК 61107 Mode C (<code>"device_type": "energomera_iec_mode_c"</code>).</p>
<p>Режим "быстрого группового чтения" специфичен для протокола счётчиков Энергомера и не соответствует стандарту ГОСТ МЭК 61107. Список параметров, доступных для чтения, приведён в Таблице 11 <a href="http://www.energomera.ru/documentations/product/ce301_303_rp.pdf">руководства пользователя счётчиков CE301/303</a>. Поддерживаются только параметры с пустым запросом и с запросом-битовой маской.</p>
<p>Параметры кодируются в адресе регистра как <code>0xAABBCC</code>, где <code>AA</code> - "тип" параметра, <code>BB</code> - "уточнение", <code>СС</code> - номер бита из битовой маски запроса.</p>
<p>Режим ГОСТ МЭК 61107 Mode C соответствует стандарту, список параметров, доступных для чтения, можно найти в руководствах конкретных счётчиков. Параметры кодируются в адресе регистра строкой, она должна содержать полный запрос, включая <code>(</code> и <code>)</code>. Например, суммарные показания энергии для счётчика Энергомера СЕ102М будут иметь адрес <code>ET0PE(1)</code>.</p>
<h3 id="нева-мт-32х-гост-мэк-61107">НЕВА МТ 32х ГОСТ МЭК 61107<a class="headerlink" href="#нева-мт-32х-гост-мэк-61107" title="Permanent link">&para;</a></h3>
<p>При любых настройках порта фактический обмен с счётчиками происходит в режиме 9600 7E1, в соответствии с МЭК 61107.</p>
<p>Реализован режим чтения параметров по OBIS-кодам (<a href="https://en.wikipedia.org/wiki/IEC_62056">IEC 62056-6-1:2017</a>) </p>
<p>OBIS-коды кодируются в адресе регистра следующим образом:</p>
<pre><code>0xCCDDEEFF
</code></pre>
<p>где <code>CC</code> - группа С, <code>DD</code> - группа D, <code>EE</code> - группа E, <code>FF</code> - группа F OBIS-кода.</p>
<h3 id="dlmscosem-и-сподэс">DLMS/COSEM и СПОДЭС<a class="headerlink" href="#dlmscosem-и-сподэс" title="Permanent link">&para;</a></h3>
<p>Физический адрес устройства задаётся в параметре <code>slave_id</code>. Опрашивается логическое устройство с адресом 1.
Адрес клиента задаётся в параметре <code>dlms_client_address</code>, если он не задан, используется адрес 16 (публичный клиент).
Тип аутентификации задаётся в параметре <code>dlms_auth</code>.</p>
<p>Коммуникационный профиль задаётся в параметре <code>dlms_interface</code>, если он не задан, используется протокол HDLC. Поддерживается адресация по логическому имени объектов.</p>
<p>Данные читаются по OBIS-кодам (<a href="https://en.wikipedia.org/wiki/IEC_62056">IEC 62056-6-1:2017</a>). OBIS-коды записываются в адресе регистра строкой, например <code>0.0.96.9.0.255</code>. Поддерживается автоматический разбор данных от объектов с классом <code>register</code>(class_id = 3), остальные классы не поддерживаются.</p>
<p>Реализован анализ доступных объектов устройства и генерация шаблона. Для этого надо остановить <code>wb-mqtt-serial</code> и запустить его из командной строки с параметром <code>-G</code>. Сгенерированный шаблон будет записан в каталог <code>/etc/wb-mqtt-serial.conf.d/templates</code>.</p>
<p>Пример команд для генерации шаблона:
<div class="highlight"><pre><span></span><code><span class="c1"># systemctl stop wb-mqtt-serial</span>
<span class="c1"># wb-mqtt-serial -G print_all,/dev/ttyMOD3,9600-8-N-1,dlms_hdlc:75,32,low,12345678</span>
<span class="c1"># systemctl start wb-mqtt-serial</span>
</code></pre></div>
Подробнее об опциях параметра <code>-G</code> можно узнать во встроенной справке <code>wb-mqtt-serial -G help</code>.</p>
<h3 id="somfy-sdn">Somfy SDN<a class="headerlink" href="#somfy-sdn" title="Permanent link">&para;</a></h3>
<p>Тип мотора(<code>node type</code>) можно задать через параметр устройства <code>node_type</code>. По умолчанию используется Sonesse 30.
Для организации отправки команд можно использовать канал с типом регистра <code>command</code>. </p>
<p>В этом случае заголовок пакета (<code>MSG</code>) задаётся в адресе регистра. Число, записываемое в такой регистр должно содержать длину в младшем байте. Например, <code>0x03020103</code> будет означать, что в команду будет добавлено 3 байта: 0x01, 0x02, 0x03.</p>
<p>Для организации запроса статуса или значений настроек можно использовать канал с типом регистра <code>param</code>. В этом случае заголовок запроса (<code>MSG</code>) задаётся в адресе регистра. А заголовок ответа - в параметре <code>response_header</code>. Поддерживается возможность указать смещение и длину данных в ответе.
Для организации записи настроек надо указать в параметре <code>write_address</code> заголовок setup-пакета.</p>
<h3 id="windeco">WinDeco<a class="headerlink" href="#windeco" title="Permanent link">&para;</a></h3>
<p>Для организации отправки команд можно использовать канал с типом регистра <code>command</code>. В этом случае код команды задаётся в адресе регистра.</p>
<h3 id="dooya">Dooya<a class="headerlink" href="#dooya" title="Permanent link">&para;</a></h3>
<p>Для организации отправки команд управления можно использовать канал с типом регистра <code>command</code>.
Для организации доступа к настройкам можно использовать канал с типом регистра <code>param</code>.
Во всех случаях адрес данных задаётся в адресе регистра.</p>
<h3 id="меркурий-200">Меркурий 200<a class="headerlink" href="#меркурий-200" title="Permanent link">&para;</a></h3>
<p>Типы регистров:
- param8 - восьмибитное число
- param16 - 16-тибитное число
- param24 - 24-тибитное число
- param32 - 32-тибитное число</p>
<p>Код команды задаётся в адресе регистра, при этом младший байт задаёт смещение данных в ответе.</p>
<h3 id="таблица-шаблонов-device_type">Таблица шаблонов device_type<a class="headerlink" href="#таблица-шаблонов-device_type" title="Permanent link">&para;</a></h3>
<p>Сгруппирована по протоколам.</p>
<p><strong>Modbus-RTU</strong></p>
<table>
<thead>
<tr>
<th align="center">Device</th>
<th align="center">device_type</th>
<th align="center">id_prefix</th>
<th align="center">name_prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">"Разумный дом" четырёхканальный диммер светодиодов DDL4</td>
<td align="center">DDL24</td>
<td align="center">ddl24</td>
<td align="center">DDL24</td>
</tr>
<tr>
<td align="center">"Разумный дом" релейный модуль DRB88</td>
<td align="center">DRB88</td>
<td align="center">drb88</td>
<td align="center">DRB88</td>
</tr>
<tr>
<td align="center">RD DDL04R LED Strip Dimmer</td>
<td align="center">DDL04R</td>
<td align="center">ddl04r</td>
<td align="center">DDL04R</td>
</tr>
<tr>
<td align="center">"ICP DAS" модуль управления освещением LC-103</td>
<td align="center">LC-103</td>
<td align="center">lc-103</td>
<td align="center">LC-103</td>
</tr>
<tr>
<td align="center">"Разумный дом" MSU24</td>
<td align="center">MSU24</td>
<td align="center">msu24</td>
<td align="center">MSU24</td>
</tr>
<tr>
<td align="center">"Разумный дом" MSU21</td>
<td align="center">MSU21</td>
<td align="center">msu21</td>
<td align="center">MSU21</td>
</tr>
<tr>
<td align="center">"Разумный дом" MSU34+TLP</td>
<td align="center">MSU34</td>
<td align="center">msu34tlp</td>
<td align="center">MSU34+TLP</td>
</tr>
<tr>
<td align="center">"Разумный дом" MSU34+TLHP</td>
<td align="center">MSU34TLHP</td>
<td align="center">msu34tlhp</td>
<td align="center">MSU34+TLHP</td>
</tr>
<tr>
<td align="center">"ICP DAS" модуль ввода-вывода TM-P3R3</td>
<td align="center">TM-P3R3</td>
<td align="center">TM-P3R3</td>
<td align="center">tmp3r3</td>
</tr>
<tr>
<td align="center">"Kvadro" модуль подключения термометров 1-wire</td>
<td align="center">kvadro-1wire</td>
<td align="center">kvadro-1wire</td>
<td align="center">Kvadro 1-Wire</td>
</tr>
<tr>
<td align="center">PD561Z-9SY счётчик электроэнергии</td>
<td align="center">PD561Z</td>
<td align="center">pd561z</td>
<td align="center">pd561z</td>
</tr>
<tr>
<td align="center">SDM220 счётчик электроэнергии</td>
<td align="center">SDM220</td>
<td align="center">sdm220</td>
<td align="center">sdm220</td>
</tr>
<tr>
<td align="center">SDM120 счётчик электроэнергии</td>
<td align="center">SDM120</td>
<td align="center">sdm120</td>
<td align="center">sdm120</td>
</tr>
<tr>
<td align="center">WELLPRO WP8028ADAM (8DI/8DO)</td>
<td align="center">WP8028ADAM</td>
<td align="center">wp8028adam</td>
<td align="center">WP8028ADAM</td>
</tr>
<tr>
<td align="center">Wiren Board RGB-диммер WB-MRGB</td>
<td align="center">WB-MRGB</td>
<td align="center">WB-MRGB</td>
<td align="center">wb-mrgb</td>
</tr>
<tr>
<td align="center">Wiren Board Релейный модуль WB-MRM2</td>
<td align="center">WB-MRM2</td>
<td align="center">WB-MRM2</td>
<td align="center">wb-mrm2</td>
</tr>
<tr>
<td align="center">Wiren Board Релейный модуль WB-MR11</td>
<td align="center">WB-MR11</td>
<td align="center">WB-MR11</td>
<td align="center">wb-mr11</td>
</tr>
<tr>
<td align="center">Wiren Board Релейный модуль WB-MR14</td>
<td align="center">WB-MR14</td>
<td align="center">WB-MR14</td>
<td align="center">wb-mr14</td>
</tr>
<tr>
<td align="center">Wiren Board модуль дискретных/счётных входов WB-MCM16</td>
<td align="center">WB-MCM16</td>
<td align="center">WB-MCM16</td>
<td align="center">wb-mcm16</td>
</tr>
<tr>
<td align="center">Wiren Board Датчик WB-MS-THLS / WB-MSW-THLS</td>
<td align="center">WB-MS-THLS</td>
<td align="center">wb-ms-thls</td>
<td align="center">WB-MS-THLS</td>
</tr>
<tr>
<td align="center">Wiren Board Датчик WB-MS-THLS / WB-MSW-THLS  (fw. v.2)</td>
<td align="center">WB-MS-THLS v.2</td>
<td align="center">wb-ms-thls</td>
<td align="center">WB-MS-THLS</td>
</tr>
<tr>
<td align="center">Peacefair PZEM-016</td>
<td align="center">PZEM-016</td>
<td align="center">pzem</td>
<td align="center">PZEM</td>
</tr>
</tbody>
</table>
<p><strong>Милур</strong>
|                     Device                     | device_type   | id_prefix | name_prefix      |
|:----------------------------------------------:|:-------------:|:---------:|:----------------:|
| Счётчик электроэнергии Милур-305               | milur305      | milur305  | Milur 305        |
| Счётчик электроэнергии Милур-105 (Милур-104)   | Milur 104/105 | milur105  | Milur 105        |</p>
<p><strong>Mercury 230</strong>
|                     Device                     | device_type | id_prefix      | name_prefix      |
|:----------------------------------------------:|:-----------:|:--------------:|:----------------:|
| Счётчик электроэнергии Меркурий-230            | mercury230  | mercury230ar02 | Mercury 230AR-02 |</p>
<p><strong>Uniel</strong>
|                     Device                     | device_type | id_prefix      | name_prefix      |
|:----------------------------------------------:|:-----------:|:--------------:|:----------------:|
| Модуль управления освещением UCH-M111RX        | UCH-M111RX  | uchm111rx      | UCH-M111RX 0808  |
| Модуль управления автоматикой UCH-M121RX       | UCH-M121RX  | uchm121rx      | UCH-M121RX 0808  |
| Диммер светодиодных ламп UCH-M141RC            | UCH-M141RC  | uchm141rc      | UCH-M141RC 0808  |</p>
<p><strong>ИВТМ</strong>
|                     Device                     | device_type | id_prefix      | name_prefix      |
|:----------------------------------------------:|:-----------:|:--------------:|:----------------:|
| Термогигрометр ИВТМ-7 М 3                      | IVTM-7M-3   | ivtm7m3        | IVTM-7M-3        |</p>
<p><strong>Пульсар</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Счётчик воды "Пульсар"                         | pulsar-water   | pulsar-water   |  Pulsar Water Meter   |
| Счётчик воды многоструйный "Пульсар-М"         | pulsar-m-water | pulsar-m-water |  Pulsar-M Water Meter |
| Счётчик тепла "Пульсар"                        | pulsar-heat    | pulsar-heat    |  Pulsar Heat Meter    |</p>
<p><strong>Энергомера МЭК 61107</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Энергомера CE301 счётчик активной электрической энергии трёхфазный                         | Energomera CE301/CE303   | energomera301   |  Energomera CE301   |
| Энергомера CE303 счётчик активной и реактивной электрической энергии трёхфазный                         | Energomera CE303   | energomera303   |  Energomera CE303   |</p>
<p><strong>НЕВА МТ 323/324</strong>
|                       Device                     | device_type   | id_prefix      | name_prefix   |
|:------------------------------------------------:|:-------------:|:--------------:|:-------------:|
| НЕВА МТ 323/324 трёхфазный многотарифный счётчик | NEVA MT 32x   | neva32x        |  NEVA MT 32x  |</p>
<p><strong>DLMS/COSEM, СПОДЭС</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Энергомера CE308 Z счетчик электроэнергии трехфазный многофункциональный | energomera_ce308_dlms   | energomera308   |  Energomera CE308   |
| Счётчик электроэнергии Меркурий 234 D          | mercury_234_dlms   | mercury234   |  Mercury 234   |</p>
<p><strong>Somfy SDN</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами Somfy SDN             | Somfy SDN      | somfy          |  Somfy SDN            |</p>
<p><strong>WinDeco</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами WinDeco               | WinDeco        | windeco        |  WinDeco              |</p>
<p><strong>Dooya</strong>
|                     Device                     | device_type    | id_prefix      | name_prefix           |
|:----------------------------------------------:|:--------------:|:--------------:|:---------------------:|
| Мотор управления шторами Dooya DT82            | Dooya 82       | dooya          |  Dooya 82             |
| Мотор управления шторами Akko AM82             | Dooya 82       | dooya          |  Dooya 82             |</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Последнее обновление:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 21, 2023</span>
      
        <br>
        Дата создания:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 21, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.tabs.link", "content.action.edit", "search.highlight", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440", "clipboard.copy": "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432 \u0431\u0443\u0444\u0435\u0440", "search.result.more.one": "\u0415\u0449\u0451 1 \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435", "search.result.more.other": "\u0415\u0449\u0451 # \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435", "search.result.none": "\u0421\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e", "search.result.one": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e 1 \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0435", "search.result.other": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439: #", "search.result.placeholder": "\u041d\u0430\u0447\u043d\u0438\u0442\u0435 \u043f\u0435\u0447\u0430\u0442\u0430\u0442\u044c \u0434\u043b\u044f \u043f\u043e\u0438\u0441\u043a\u0430", "search.result.term.missing": "\u041e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442", "select.version": "\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044e"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>